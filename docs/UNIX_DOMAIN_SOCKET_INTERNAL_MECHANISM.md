# Unix Domain Socket å†…éƒ¨æœºåˆ¶è¯¦è§£

> æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† Unix Domain Socket (UDS) ä»å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„å®Œæ•´å·¥ä½œæµç¨‹ï¼ŒåŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ã€å†…æ ¸æ“ä½œã€å¤šå®¢æˆ·ç«¯é˜Ÿåˆ—ç®¡ç†ä»¥åŠåœ°å€è¯†åˆ«æœºåˆ¶ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [åˆå§‹åŒ–é˜¶æ®µ](#2-åˆå§‹åŒ–é˜¶æ®µ)
3. [ç³»ç»Ÿè°ƒç”¨è¯¦è§£](#3-ç³»ç»Ÿè°ƒç”¨è¯¦è§£)
4. [æ•°æ®å‘é€æµç¨‹](#4-æ•°æ®å‘é€æµç¨‹)
5. [å¤šå®¢æˆ·ç«¯é˜Ÿåˆ—æœºåˆ¶](#5-å¤šå®¢æˆ·ç«¯é˜Ÿåˆ—æœºåˆ¶)
6. [æ•°æ®æ¥æ”¶æµç¨‹](#6-æ•°æ®æ¥æ”¶æµç¨‹)
7. [å®¢æˆ·ç«¯åœ°å€è¯†åˆ«æœºåˆ¶](#7-å®¢æˆ·ç«¯åœ°å€è¯†åˆ«æœºåˆ¶)
8. [å®Œæ•´äº¤äº’ç¤ºä¾‹](#8-å®Œæ•´äº¤äº’ç¤ºä¾‹)
9. [å†…æ ¸æ•°æ®ç»“æ„](#9-å†…æ ¸æ•°æ®ç»“æ„)
10. [æ€§èƒ½åˆ†æ](#10-æ€§èƒ½åˆ†æ)

---

## 1. æ¦‚è¿°

### 1.1 é€šä¿¡æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client 1   â”‚â”€â”€â”€â”                      â”Œâ”€â”€â†’â”‚   Client 1   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client 2   â”‚â”€â”€â”€â”¼â”€â”€â”€â†’â”‚  Server  â”‚â”€â”€â”€â”€â”€â”¼â”€â”€â†’â”‚   Client 2   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client 3   â”‚â”€â”€â”€â”˜                      â””â”€â”€â†’â”‚   Client 3   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    å‘é€è¯·æ±‚                                    æ¥æ”¶å“åº”
```

### 1.2 æ ¸å¿ƒç‰¹æ€§

- **é€šä¿¡æ–¹å¼**: SOCK_DGRAM (æ•°æ®æŠ¥æ¨¡å¼ï¼Œæ— è¿æ¥)
- **åœ°å€æ—**: AF_UNIX (æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡)
- **åœ°å€æ ‡è¯†**: æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ (ä¾‹å¦‚: `/tmp/server.sock`)
- **æ•°æ®ä¼ è¾“**: é€šè¿‡å†…æ ¸å†…å­˜ï¼Œæ— éœ€ç½‘ç»œæ ˆ
- **æ¶ˆæ¯è¾¹ç•Œ**: ä¿æŒæ¶ˆæ¯è¾¹ç•Œï¼Œæ¯ä¸ª `sendto()` å¯¹åº”ä¸€ä¸ªå®Œæ•´æ¶ˆæ¯

---

## 2. åˆå§‹åŒ–é˜¶æ®µ

### 2.1 æœåŠ¡ç«¯åˆå§‹åŒ–æµç¨‹

#### åº”ç”¨å±‚ä»£ç 

```cpp
// test/posix/ipc/multi_process_test/server.cpp
auto serverResult = UnixDomainSocketBuilder()
    .name("/tmp/uds_server.sock")           // æœåŠ¡ç«¯socketè·¯å¾„
    .channelSide(PosixIpcChannelSide::SERVER)
    .maxMsgSize(4096)
    .create();
```

#### åº•å±‚å®ç°

```cpp
// zerocp_foundationLib/posix/ipc/source/unix_domainsocket.cpp:24-95

std::expected<UnixDomainSocket, PosixIpcChannelError> 
UnixDomainSocketBuilder::create() const noexcept
{
    // ========== æ­¥éª¤ 1: åˆ›å»º socket ==========
    auto socketResult = ZeroCp_PosixCall(socket)(
        AF_UNIX,      // åœ°å€æ—: UNIXåŸŸ
        SOCK_DGRAM,   // ç±»å‹: æ•°æ®æŠ¥
        0             // åè®®: é»˜è®¤
    ).failureReturnValue(UnixDomainSocket::ERROR_CODE)
     .evaluate();
    
    int sockfd = socketResult.value().value;  // è·å¾—æ–‡ä»¶æè¿°ç¬¦
    
    // ========== æ­¥éª¤ 2: å‡†å¤‡åœ°å€ç»“æ„ ==========
    sockaddr_un addr{};
    addr.sun_family = AF_UNIX;
    std::memcpy(addr.sun_path, m_name.c_str(), m_name.size());
    addr.sun_path[m_name.size()] = '\0';
    
    // ========== æ­¥éª¤ 3: åˆ é™¤æ—§çš„ socket æ–‡ä»¶ ==========
    ZeroCp_PosixCall(unlink)(m_name.c_str())
        .failureReturnValue(UnixDomainSocket::ERROR_CODE)
        .ignoreErrnos(ENOENT)  // å¿½ç•¥"æ–‡ä»¶ä¸å­˜åœ¨"é”™è¯¯
        .evaluate();
    
    // ========== æ­¥éª¤ 4: ç»‘å®šåˆ°æ–‡ä»¶è·¯å¾„ ==========
    auto bindResult = ZeroCp_PosixCall(bind)(
        sockfd,
        reinterpret_cast<const struct sockaddr*>(&addr),
        sizeof(addr)
    ).failureReturnValue(UnixDomainSocket::ERROR_CODE)
     .evaluate();
    
    // è¿”å›åˆ›å»ºçš„ UnixDomainSocket å¯¹è±¡
    return UnixDomainSocket(m_name, m_channelSide, sockfd, addr, m_maxMsgSize);
}
```

#### å†…æ ¸å±‚æ“ä½œè¯¦è§£

##### æ­¥éª¤ 1: `socket(AF_UNIX, SOCK_DGRAM, 0)` ç³»ç»Ÿè°ƒç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å†…æ ¸ç©ºé—´æ“ä½œ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ 1. sys_socket() ç³»ç»Ÿè°ƒç”¨å…¥å£                                 â”‚
â”‚    â†“                                                         â”‚
â”‚ 2. sock_create(AF_UNIX, SOCK_DGRAM, 0, &sock)              â”‚
â”‚    â†“                                                         â”‚
â”‚ 3. åˆ†é…æ ¸å¿ƒæ•°æ®ç»“æ„:                                         â”‚
â”‚                                                              â”‚
â”‚    struct socket *sock = sock_alloc();                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚    â”‚ struct socket {                â”‚                       â”‚
â”‚    â”‚   struct sock *sk;   â”€â”€â”€â”€â”€â”€â”   â”‚                       â”‚
â”‚    â”‚   const struct proto_ops *ops; â”‚                       â”‚
â”‚    â”‚   struct file *file;       â”‚   â”‚                       â”‚
â”‚    â”‚   ...                      â”‚   â”‚                       â”‚
â”‚    â”‚ }                          â”‚   â”‚                       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”˜                       â”‚
â”‚                                 â”‚                            â”‚
â”‚                                 â†“                            â”‚
â”‚    struct unix_sock *u = unix_create1(sock);                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚    â”‚ struct unix_sock {                     â”‚               â”‚
â”‚    â”‚   struct sock sk;                      â”‚               â”‚
â”‚    â”‚   struct path path;          // ç»‘å®šè·¯å¾„â”‚               â”‚
â”‚    â”‚   spinlock_t lock;           // è‡ªæ—‹é”  â”‚               â”‚
â”‚    â”‚   struct sk_buff_head receive_queue;  // æ¥æ”¶é˜Ÿåˆ—      â”‚
â”‚    â”‚   wait_queue_head_t peer_wait;  // ç­‰å¾…é˜Ÿåˆ—å¤´          â”‚
â”‚    â”‚   atomic_t inflight;         // ä¼ è¾“ä¸­æ¶ˆæ¯æ•°           â”‚
â”‚    â”‚   ...                                   â”‚               â”‚
â”‚    â”‚ }                                       â”‚               â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                              â”‚
â”‚ 4. åˆå§‹åŒ–æ¥æ”¶é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—:                                  â”‚
â”‚    skb_queue_head_init(&u->receive_queue);                  â”‚
â”‚    init_waitqueue_head(&u->peer_wait);                      â”‚
â”‚                                                              â”‚
â”‚ 5. åˆ†é…æ–‡ä»¶æè¿°ç¬¦:                                           â”‚
â”‚    fd = sock_map_fd(sock, 0);                               â”‚
â”‚    // è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œä¾‹å¦‚ fd=3                              â”‚
â”‚                                                              â”‚
â”‚ 6. è¿”å›ç”¨æˆ·ç©ºé—´:                                             â”‚
â”‚    return fd;  // 3                                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### æ­¥éª¤ 2: `bind(sockfd, addr, addrlen)` ç³»ç»Ÿè°ƒç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å†…æ ¸ç©ºé—´æ“ä½œ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ 1. sys_bind() ç³»ç»Ÿè°ƒç”¨å…¥å£                                   â”‚
â”‚    å‚æ•°: fd=3, addr="/tmp/uds_server.sock", addrlen=110    â”‚
â”‚    â†“                                                         â”‚
â”‚ 2. æ ¹æ®æ–‡ä»¶æè¿°ç¬¦æ‰¾åˆ° socket:                                â”‚
â”‚    struct socket *sock = sockfd_lookup(fd);                 â”‚
â”‚    struct unix_sock *u = unix_sk(sock->sk);                â”‚
â”‚    â†“                                                         â”‚
â”‚ 3. æ£€æŸ¥åœ°å€æœ‰æ•ˆæ€§:                                           â”‚
â”‚    if (addr->sun_family != AF_UNIX) return -EINVAL;        â”‚
â”‚    if (strlen(addr->sun_path) >= UNIX_PATH_MAX) return -E...â”‚
â”‚    â†“                                                         â”‚
â”‚ 4. åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»º socket æ–‡ä»¶:                             â”‚
â”‚    vfs_mknod(parent_inode,                                  â”‚
â”‚              dentry,                                         â”‚
â”‚              S_IFSOCK | 0777,  // socket æ–‡ä»¶ + æƒé™         â”‚
â”‚              0);                                             â”‚
â”‚    â†“                                                         â”‚
â”‚ 5. åˆ›å»º inode å¹¶å…³è”:                                        â”‚
â”‚    struct inode *inode = new_inode(sb);                     â”‚
â”‚    inode->i_mode = S_IFSOCK | 0777;                         â”‚
â”‚    inode->i_uid = current_fsuid();                          â”‚
â”‚    inode->i_gid = current_fsgid();                          â”‚
â”‚    â†“                                                         â”‚
â”‚ 6. å°†è·¯å¾„ä¿å­˜åˆ° unix_sock:                                   â”‚
â”‚    u->path.dentry = dentry;   // /tmp/uds_server.sock      â”‚
â”‚    u->path.mnt = mnt;                                       â”‚
â”‚    â†“                                                         â”‚
â”‚ 7. å°† socket åŠ å…¥å…¨å±€å“ˆå¸Œè¡¨:                                 â”‚
â”‚    // é€šè¿‡è·¯å¾„å¿«é€ŸæŸ¥æ‰¾ socket                                â”‚
â”‚    unix_insert_socket(u);                                   â”‚
â”‚    â†“                                                         â”‚
â”‚ 8. æ ‡è®°ä¸ºå·²ç»‘å®šçŠ¶æ€:                                         â”‚
â”‚    sock->state = SS_BOUND;                                  â”‚
â”‚    â†“                                                         â”‚
â”‚ 9. è¿”å›ç”¨æˆ·ç©ºé—´:                                             â”‚
â”‚    return 0;  // æˆåŠŸ                                       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**: 
- Socket æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å¯è§ (`ls -l /tmp/uds_server.sock`)
- ç±»å‹ä¸º `s` (socket): `srwxrwxrwx 1 user user 0 Oct 21 10:00 /tmp/uds_server.sock`
- å†…æ ¸ç»´æŠ¤è·¯å¾„åˆ° `unix_sock` çš„æ˜ å°„å…³ç³»

---

### 2.2 å®¢æˆ·ç«¯åˆå§‹åŒ–æµç¨‹

#### åº”ç”¨å±‚ä»£ç 

```cpp
// test/posix/ipc/multi_process_test/client1.cpp
auto clientResult = UnixDomainSocketBuilder()
    .name("/tmp/uds_client_1.sock")         // å®¢æˆ·ç«¯socketè·¯å¾„
    .channelSide(PosixIpcChannelSide::CLIENT)
    .maxMsgSize(4096)
    .create();
```

#### åº•å±‚æµç¨‹

**ä¸æœåŠ¡ç«¯å®Œå…¨ç›¸åŒ**:
1. è°ƒç”¨ `socket()` åˆ›å»º socket
2. è°ƒç”¨ `bind()` ç»‘å®šåˆ° `/tmp/uds_client_1.sock`
3. å†…æ ¸åˆ›å»ºå¯¹åº”çš„ `unix_sock` å’Œæ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹

**åˆå§‹åŒ–åçš„æ–‡ä»¶ç³»ç»ŸçŠ¶æ€**:

```bash
$ ls -l /tmp/*.sock
srwxrwxrwx 1 user user 0 Oct 21 10:00 /tmp/uds_server.sock
srwxrwxrwx 1 user user 0 Oct 21 10:00 /tmp/uds_client_1.sock
srwxrwxrwx 1 user user 0 Oct 21 10:01 /tmp/uds_client_2.sock
srwxrwxrwx 1 user user 0 Oct 21 10:01 /tmp/uds_client_3.sock
```

---

## 3. ç³»ç»Ÿè°ƒç”¨è¯¦è§£

### 3.1 sendto() - å‘é€æ•°æ®

#### å‡½æ•°åŸå‹

```c
#include <sys/socket.h>

ssize_t sendto(int sockfd,              // socket æ–‡ä»¶æè¿°ç¬¦
               const void *buf,         // è¦å‘é€çš„æ•°æ®ç¼“å†²åŒº
               size_t len,              // æ•°æ®é•¿åº¦
               int flags,               // æ ‡å¿—ä½ (é€šå¸¸ä¸º0)
               const struct sockaddr *dest_addr,  // ç›®æ ‡åœ°å€
               socklen_t addrlen);      // åœ°å€ç»“æ„é•¿åº¦
```

#### è¿”å›å€¼

- **æˆåŠŸ**: è¿”å›å®é™…å‘é€çš„å­—èŠ‚æ•°
- **å¤±è´¥**: è¿”å› -1ï¼Œè®¾ç½® errno

#### åº”ç”¨å±‚ä½¿ç”¨

```cpp
// zerocp_foundationLib/posix/ipc/source/unix_domainsocket.cpp:238-258

std::expected<void, PosixIpcChannelError> 
UnixDomainSocket::sendTo(const std::string& msg,
                          const sockaddr_un& toAddr) const noexcept
{
    auto sendResult = ZeroCp_PosixCall(sendto)(
        m_socketFd,                                    // å‘é€è€…çš„ fd
        msg.c_str(),                                   // æ¶ˆæ¯å†…å®¹
        msg.length(),                                  // æ¶ˆæ¯é•¿åº¦
        0,                                             // flags
        reinterpret_cast<const sockaddr*>(&toAddr),   // ç›®æ ‡åœ°å€
        sizeof(toAddr)                                 // åœ°å€é•¿åº¦
    ).failureReturnValue(ERROR_CODE)
     .evaluate();
    
    if (!sendResult.has_value()) {
        return std::unexpected(errnoToEnum(m_name, sendResult.error().errnum));
    }
    
    return {};
}
```

---

### 3.2 recvfrom() - æ¥æ”¶æ•°æ®

#### å‡½æ•°åŸå‹

```c
#include <sys/socket.h>

ssize_t recvfrom(int sockfd,                 // socket æ–‡ä»¶æè¿°ç¬¦
                 void *buf,                  // æ¥æ”¶ç¼“å†²åŒº
                 size_t len,                 // ç¼“å†²åŒºå¤§å°
                 int flags,                  // æ ‡å¿—ä½ (é€šå¸¸ä¸º0)
                 struct sockaddr *src_addr,  // â­ è¾“å‡º: å‘é€è€…åœ°å€
                 socklen_t *addrlen);        // â­ è¾“å…¥/è¾“å‡º: åœ°å€é•¿åº¦
```

#### è¿”å›å€¼

- **æˆåŠŸ**: è¿”å›æ¥æ”¶åˆ°çš„å­—èŠ‚æ•°
- **å¤±è´¥**: è¿”å› -1ï¼Œè®¾ç½® errno
- **è¿æ¥å…³é—­**: è¿”å› 0

#### åº”ç”¨å±‚ä½¿ç”¨

```cpp
// zerocp_foundationLib/posix/ipc/source/unix_domainsocket.cpp:196-224

std::expected<std::string, PosixIpcChannelError> 
UnixDomainSocket::receiveFrom(std::string& msg,
                               sockaddr_un& fromAddr) const noexcept
{
    std::vector<char> buffer(m_maxMsgSize);
    socklen_t fromLen = sizeof(fromAddr);
    
    auto recvResult = ZeroCp_PosixCall(recvfrom)(
        m_socketFd,                               // æ¥æ”¶è€…çš„ fd
        buffer.data(),                            // æ¥æ”¶ç¼“å†²åŒº
        buffer.size() - 1,                        // ç¼“å†²åŒºå¤§å°
        0,                                        // flags
        reinterpret_cast<sockaddr*>(&fromAddr),  // â­ è¾“å‡ºå‚æ•°
        &fromLen                                  // â­ è¾“å‡ºå‚æ•°
    ).failureReturnValue(ERROR_CODE)
     .evaluate();
    
    if (!recvResult.has_value()) {
        return std::unexpected(errnoToEnum(m_name, recvResult.error().errnum));
    }
    
    ssize_t bytesReceived = recvResult.value().value;
    buffer[bytesReceived] = '\0';
    msg = std::string(buffer.data(), bytesReceived);
    
    return msg;
}
```

**å…³é”®ç‚¹**:
- `fromAddr` æ˜¯**è¾“å‡ºå‚æ•°**ï¼Œå†…æ ¸ä¼šå¡«å……å‘é€è€…çš„åœ°å€ä¿¡æ¯
- `fromAddr.sun_path` åŒ…å«å‘é€è€…çš„ socket è·¯å¾„ (ä¾‹å¦‚: `/tmp/uds_client_1.sock`)

---

## 4. æ•°æ®å‘é€æµç¨‹

### 4.1 å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯

#### åº”ç”¨å±‚è°ƒç”¨

```cpp
// test/posix/ipc/multi_process_test/client1.cpp

std::string message = "Client-1 Message-1";

// æ„é€ æœåŠ¡ç«¯åœ°å€
sockaddr_un serverAddr{};
serverAddr.sun_family = AF_UNIX;
std::strncpy(serverAddr.sun_path, "/tmp/uds_server.sock", sizeof(serverAddr.sun_path) - 1);

// å‘é€æ¶ˆæ¯
auto sendResult = client.sendTo(message, serverAddr);
```

#### ç³»ç»Ÿè°ƒç”¨æµç¨‹

```
ç”¨æˆ·ç©ºé—´                          å†…æ ¸ç©ºé—´
â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€

client.sendTo(msg, serverAddr)
    â†“
sendto(fd=3,
       buf="Client-1 Message-1",
       len=19,
       flags=0,
       dest_addr={
           sun_family=AF_UNIX,
           sun_path="/tmp/uds_server.sock"
       },
       addrlen=110)
    â†“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              ç³»ç»Ÿè°ƒç”¨è¾¹ç•Œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                  â†“
                            sys_sendto()
```

### 4.2 å†…æ ¸å¤„ç†è¯¦ç»†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           sys_sendto() å†…æ ¸å¤„ç†æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 1 æ­¥ã€‘è·å–å‘é€è€…çš„ socket                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚   struct socket *sock = sockfd_lookup(sockfd);  // fd=3         â”‚
â”‚   struct unix_sock *u_sender = unix_sk(sock->sk);              â”‚
â”‚                                                                  â”‚
â”‚   å‘é€è€…ä¿¡æ¯:                                                     â”‚
â”‚   â€¢ fd = 3                                                      â”‚
â”‚   â€¢ path = "/tmp/uds_client_1.sock"                            â”‚
â”‚   â€¢ unix_sock æŒ‡é’ˆ = 0xffff8800...                              â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 2 æ­¥ã€‘æ ¹æ®ç›®æ ‡è·¯å¾„æŸ¥æ‰¾æ¥æ”¶è€…çš„ socket                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   // ç›®æ ‡è·¯å¾„: "/tmp/uds_server.sock"                           â”‚
â”‚   struct path path;                                             â”‚
â”‚   kern_path(dest_addr->sun_path, LOOKUP_FOLLOW, &path);        â”‚
â”‚   â†“                                                              â”‚
â”‚   struct inode *inode = path.dentry->d_inode;                   â”‚
â”‚   â†“                                                              â”‚
â”‚   // ä» inode è·å– unix_sock                                     â”‚
â”‚   struct unix_sock *u_receiver = unix_find_socket_byinode(inode);â”‚
â”‚                                                                  â”‚
â”‚   æ¥æ”¶è€…ä¿¡æ¯:                                                     â”‚
â”‚   â€¢ path = "/tmp/uds_server.sock"                              â”‚
â”‚   â€¢ unix_sock æŒ‡é’ˆ = 0xffff8801...                              â”‚
â”‚   â€¢ receive_queue = &u_receiver->receive_queue                 â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 3 æ­¥ã€‘åˆ†é… socket buffer (sk_buff)                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   struct sk_buff *skb;                                          â”‚
â”‚   skb = sock_alloc_send_skb(sk,                                 â”‚
â”‚                             len + UNIX_SKB_FRAGS_SZ,            â”‚
â”‚                             flags & MSG_DONTWAIT,               â”‚
â”‚                             &err);                              â”‚
â”‚                                                                  â”‚
â”‚   sk_buff ç»“æ„:                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ struct sk_buff {                       â”‚                   â”‚
â”‚   â”‚   unsigned char *head;   // ç¼“å†²åŒºå¤´    â”‚                   â”‚
â”‚   â”‚   unsigned char *data;   // æ•°æ®èµ·å§‹    â”‚                   â”‚
â”‚   â”‚   unsigned int len;      // æ•°æ®é•¿åº¦    â”‚                   â”‚
â”‚   â”‚   struct sk_buff *next;  // é“¾è¡¨æŒ‡é’ˆ    â”‚                   â”‚
â”‚   â”‚   ...                                   â”‚                   â”‚
â”‚   â”‚   // Unix socket ç‰¹å®šæ•°æ®               â”‚                   â”‚
â”‚   â”‚   struct sockaddr_un sender_addr; â­    â”‚                   â”‚
â”‚   â”‚ }                                       â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                  â”‚
â”‚   åˆ†é…å¤§å° = 19 bytes (æ•°æ®) + å…ƒæ•°æ®å¼€é”€                         â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 4 æ­¥ã€‘æ‹·è´ç”¨æˆ·æ•°æ®åˆ° sk_buff                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   // ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´                                     â”‚
â”‚   if (copy_from_user(skb_put(skb, len), buf, len)) {           â”‚
â”‚       kfree_skb(skb);                                           â”‚
â”‚       return -EFAULT;                                           â”‚
â”‚   }                                                             â”‚
â”‚                                                                  â”‚
â”‚   æ‹·è´ç»“æœ:                                                       â”‚
â”‚   skb->data = "Client-1 Message-1"                             â”‚
â”‚   skb->len = 19                                                â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 5 æ­¥ã€‘ä¿å­˜å‘é€è€…åœ°å€åˆ° sk_buff â­ å…³é”®ï¼                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   // è·å–å‘é€è€…çš„ç»‘å®šåœ°å€                                         â”‚
â”‚   struct sockaddr_un *sender_addr = &u_sender->addr;            â”‚
â”‚   // sender_addr->sun_path = "/tmp/uds_client_1.sock"          â”‚
â”‚                                                                  â”‚
â”‚   // ä¿å­˜åˆ° sk_buff çš„æ§åˆ¶ä¿¡æ¯ä¸­                                  â”‚
â”‚   UNIXCB(skb).addr = sender_addr;                               â”‚
â”‚   // æˆ–è€…ç›´æ¥æ‹·è´                                                 â”‚
â”‚   memcpy(&skb->cb, sender_addr, sizeof(struct sockaddr_un));   â”‚
â”‚                                                                  â”‚
â”‚   â­ è¿™å°±æ˜¯æ¥æ”¶ç«¯èƒ½çŸ¥é“å‘é€è€…åœ°å€çš„ç§˜å¯†ï¼                          â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 6 æ­¥ã€‘å°† sk_buff åŠ å…¥æ¥æ”¶è€…çš„é˜Ÿåˆ—                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   // åŠ é”ä¿æŠ¤é˜Ÿåˆ—æ“ä½œ                                             â”‚
â”‚   spin_lock(&u_receiver->lock);                                 â”‚
â”‚                                                                  â”‚
â”‚   // å°† sk_buff æ·»åŠ åˆ°æ¥æ”¶é˜Ÿåˆ—å°¾éƒ¨                                â”‚
â”‚   skb_queue_tail(&u_receiver->receive_queue, skb);              â”‚
â”‚                                                                  â”‚
â”‚   // è§£é”                                                        â”‚
â”‚   spin_unlock(&u_receiver->lock);                               â”‚
â”‚                                                                  â”‚
â”‚   é˜Ÿåˆ—çŠ¶æ€:                                                       â”‚
â”‚   u_receiver->receive_queue:                                    â”‚
â”‚   head â†’ [skb1] â†’ [skb2] â†’ [skb3] â† tail                       â”‚
â”‚                              â†‘                                   â”‚
â”‚                         åˆšåŠ å…¥çš„ skb                              â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 7 æ­¥ã€‘å”¤é†’ç­‰å¾…çš„æ¥æ”¶è¿›ç¨‹                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   // å¦‚æœæœåŠ¡ç«¯è¿›ç¨‹åœ¨ recvfrom() é˜»å¡ï¼Œç°åœ¨å”¤é†’å®ƒ                 â”‚
â”‚   wake_up_interruptible(&u_receiver->peer_wait);                â”‚
â”‚   // æˆ–                                                          â”‚
â”‚   sk->sk_data_ready(sk);                                        â”‚
â”‚                                                                  â”‚
â”‚   è¿›ç¨‹çŠ¶æ€å˜åŒ–:                                                   â”‚
â”‚   Server Process: SLEEPING â†’ RUNNABLE                           â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 8 æ­¥ã€‘è¿”å›ç”¨æˆ·ç©ºé—´                                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   return len;  // è¿”å›å‘é€çš„å­—èŠ‚æ•°: 19                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 sk_buff ç»“æ„è¯¦è§£

```c
struct sk_buff {
    // åŸºç¡€å­—æ®µ
    struct sk_buff *next;        // é“¾è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    struct sk_buff *prev;        // é“¾è¡¨å‰ä¸€ä¸ªèŠ‚ç‚¹
    
    // æ•°æ®ç¼“å†²åŒº
    unsigned char *head;         // ç¼“å†²åŒºèµ·å§‹åœ°å€
    unsigned char *data;         // å®é™…æ•°æ®èµ·å§‹åœ°å€
    unsigned char *tail;         // å®é™…æ•°æ®ç»“æŸåœ°å€
    unsigned char *end;          // ç¼“å†²åŒºç»“æŸåœ°å€
    
    unsigned int len;            // æ•°æ®é•¿åº¦
    unsigned int data_len;       // åˆ†ç‰‡æ•°æ®é•¿åº¦
    
    // æ§åˆ¶ä¿¡æ¯ç¼“å†²åŒº (48 bytes)
    char cb[48] __aligned(8);    // â­ ç”¨äºå­˜å‚¨åè®®ç‰¹å®šä¿¡æ¯
    
    // ... å…¶ä»–å­—æ®µ
};

// Unix socket ä½¿ç”¨ cb å­˜å‚¨å‘é€è€…åœ°å€
#define UNIXCB(skb) (*(struct unix_skb_parms *)&((skb)->cb))

struct unix_skb_parms {
    struct pid *pid;              // å‘é€è¿›ç¨‹ PID
    kuid_t uid;                   // å‘é€è¿›ç¨‹ UID
    kgid_t gid;                   // å‘é€è¿›ç¨‹ GID
    struct scm_fp_list *fp;       // ä¼ é€’çš„æ–‡ä»¶æè¿°ç¬¦
    u32 secid;                    // å®‰å…¨æ ‡è¯†
    struct sockaddr_un *addr;     // â­ å‘é€è€…åœ°å€
};
```

**å­˜å‚¨ç¤ºä¾‹**:

```
sk_buff å®ä¾‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ next = NULL                         â”‚
â”‚ prev = 0xffff8800...                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ head = 0xffff8801... (ç¼“å†²åŒºèµ·å§‹)   â”‚
â”‚ data = 0xffff8801... (æ•°æ®èµ·å§‹)     â”‚
â”‚ tail = 0xffff8801... (data + 19)    â”‚
â”‚ end  = 0xffff8801... (ç¼“å†²åŒºç»“æŸ)   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ len = 19                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ cb[48] = {                          â”‚
â”‚   addr->sun_family = AF_UNIX        â”‚
â”‚   addr->sun_path = "/tmp/uds_client_1.sock" â­
â”‚   pid = 12345                       â”‚
â”‚   uid = 1000                        â”‚
â”‚ }                                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ *data = "Client-1 Message-1"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å¤šå®¢æˆ·ç«¯é˜Ÿåˆ—æœºåˆ¶

### 5.1 é˜Ÿåˆ—æ•°æ®ç»“æ„

```c
// å†…æ ¸ä¸­çš„é˜Ÿåˆ—å¤´å®šä¹‰
struct sk_buff_head {
    struct sk_buff *next;       // é˜Ÿåˆ—å¤´
    struct sk_buff *prev;       // é˜Ÿåˆ—å°¾
    __u32 qlen;                 // é˜Ÿåˆ—é•¿åº¦
    spinlock_t lock;            // è‡ªæ—‹é”
};

// æ¯ä¸ª unix_sock éƒ½æœ‰ä¸€ä¸ªæ¥æ”¶é˜Ÿåˆ—
struct unix_sock {
    struct sock sk;
    struct path path;
    spinlock_t lock;
    struct sk_buff_head receive_queue;  // â­ æ¥æ”¶é˜Ÿåˆ—
    wait_queue_head_t peer_wait;        // ç­‰å¾…é˜Ÿåˆ—
    // ...
};
```

### 5.2 å¤šå®¢æˆ·ç«¯åŒæ—¶å‘é€åœºæ™¯

#### æ—¶é—´çº¿

```
æ—¶åˆ» T1:
  Client-1 è°ƒç”¨ sendto("Client-1 Message-1", server_addr)
  Client-2 è°ƒç”¨ sendto("Client-2 Message-1", server_addr)
  Client-3 è°ƒç”¨ sendto("Client-3 Message-1", server_addr)
  
  â†“ (å†…æ ¸å¤„ç†)
  
æ—¶åˆ» T2:
  Server çš„æ¥æ”¶é˜Ÿåˆ—çŠ¶æ€
```

#### å†…æ ¸é˜Ÿåˆ—æ“ä½œ

```
åˆå§‹çŠ¶æ€ (é˜Ÿåˆ—ä¸ºç©º):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Server receive_queue:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ head â†’ NULL  â”‚
â”‚ tail â†’ NULL  â”‚
â”‚ qlen = 0     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Client-1 å‘é€å:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
spin_lock(&u_receiver->lock);
skb_queue_tail(&u_receiver->receive_queue, skb1);
spin_unlock(&u_receiver->lock);

Server receive_queue:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ head â†’ [skb1]                      â”‚
â”‚          â†“                         â”‚
â”‚        data: "Client-1 Message-1"  â”‚
â”‚        sender: "/tmp/uds_client_1.sock"
â”‚        next: NULL                  â”‚
â”‚ tail â†’ [skb1]                      â”‚
â”‚ qlen = 1                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Client-2 å‘é€å (å‡ ä¹åŒæ—¶):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
spin_lock(&u_receiver->lock);  // å¯èƒ½éœ€è¦ç­‰å¾…
skb_queue_tail(&u_receiver->receive_queue, skb2);
spin_unlock(&u_receiver->lock);

Server receive_queue:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ head â†’ [skb1] â†’ [skb2]             â”‚
â”‚          â†“        â†“                â”‚
â”‚        "Cl-1"   "Cl-2"             â”‚
â”‚        client_1  client_2          â”‚
â”‚ tail â†’ [skb2]                      â”‚
â”‚ qlen = 2                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Client-3 å‘é€å:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Server receive_queue:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ head â†’ [skb1] â†’ [skb2] â†’ [skb3]          â”‚
â”‚          â†“        â†“        â†“             â”‚
â”‚        "Cl-1"   "Cl-2"   "Cl-3"          â”‚
â”‚        client_1  client_2  client_3      â”‚
â”‚ tail â†’ [skb3]                            â”‚
â”‚ qlen = 3                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 é˜Ÿåˆ—æ“ä½œå‡½æ•°

```c
// æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨
void skb_queue_tail(struct sk_buff_head *list, struct sk_buff *newsk)
{
    unsigned long flags;
    
    spin_lock_irqsave(&list->lock, flags);
    __skb_queue_tail(list, newsk);
    spin_unlock_irqrestore(&list->lock, flags);
}

// ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡º
struct sk_buff *skb_dequeue(struct sk_buff_head *list)
{
    unsigned long flags;
    struct sk_buff *result;
    
    spin_lock_irqsave(&list->lock, flags);
    result = __skb_dequeue(list);
    spin_unlock_irqrestore(&list->lock, flags);
    
    return result;
}

// æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
static inline int skb_queue_empty(const struct sk_buff_head *list)
{
    return list->next == (const struct sk_buff *) list;
}
```

### 5.4 å¹¶å‘æ§åˆ¶

#### è‡ªæ—‹é”ä¿æŠ¤

```c
// å‘é€ç«¯ A æ­£åœ¨æ·»åŠ  skb1
Thread A (Client-1 sendto):
  spin_lock(&server->lock);      // è·å–é”
  skb_queue_tail(..., skb1);     // æ·»åŠ  skb1
  spin_unlock(&server->lock);    // é‡Šæ”¾é”

// å‘é€ç«¯ B å°è¯•æ·»åŠ  skb2
Thread B (Client-2 sendto):
  spin_lock(&server->lock);      // â¸ï¸ é˜»å¡ï¼Œç­‰å¾… A é‡Šæ”¾é”
  // ... A é‡Šæ”¾é”åç»§ç»­
  skb_queue_tail(..., skb2);     // æ·»åŠ  skb2
  spin_unlock(&server->lock);

// æ¥æ”¶ç«¯æ­£åœ¨å–å‡º skb
Thread C (Server recvfrom):
  spin_lock(&server->lock);      // è·å–é”
  skb = skb_dequeue(...);        // å–å‡º skb1
  spin_unlock(&server->lock);    // é‡Šæ”¾é”
```

**ä¿è¯**:
- âœ… é˜Ÿåˆ—æ“ä½œåŸå­æ€§
- âœ… æ¶ˆæ¯é¡ºåºä¿æŒ (FIFO)
- âœ… æ— æ•°æ®ç«äº‰

---

## 6. æ•°æ®æ¥æ”¶æµç¨‹

### 6.1 æœåŠ¡ç«¯æ¥æ”¶æ¶ˆæ¯

#### åº”ç”¨å±‚è°ƒç”¨

```cpp
// test/posix/ipc/multi_process_test/server.cpp:96-142

while (g_serverRunning)
{
    std::string receivedMsg;
    sockaddr_un clientAddr;  // â­ ç”¨äºæ¥æ”¶å‘é€è€…åœ°å€
    
    // æ¥æ”¶æ¶ˆæ¯å¹¶è·å–å‘é€è€…åœ°å€
    auto recvResult = server.receiveFrom(receivedMsg, clientAddr);
    
    if (!recvResult.has_value()) {
        continue;
    }
    
    // æ˜¾ç¤ºå‘é€è€…ä¿¡æ¯
    std::string clientPath = clientAddr.sun_path;  // â­
    std::cout << "Received from: " << clientPath << "\n";
    std::cout << "Content: " << receivedMsg << "\n";
    
    // å›å¤æ¶ˆæ¯
    std::string response = "ACK: " + receivedMsg;
    server.sendTo(response, clientAddr);  // â­ ä½¿ç”¨è·å–çš„åœ°å€å›å¤
}
```

### 6.2 å†…æ ¸å¤„ç†è¯¦ç»†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          sys_recvfrom() å†…æ ¸å¤„ç†æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 1 æ­¥ã€‘è·å–æ¥æ”¶è€…çš„ socket                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   struct socket *sock = sockfd_lookup(sockfd);  // fd=3         â”‚
â”‚   struct unix_sock *u = unix_sk(sock->sk);                     â”‚
â”‚                                                                  â”‚
â”‚   æ¥æ”¶è€…ä¿¡æ¯:                                                     â”‚
â”‚   â€¢ fd = 3                                                      â”‚
â”‚   â€¢ path = "/tmp/uds_server.sock"                              â”‚
â”‚   â€¢ receive_queue = &u->receive_queue                          â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 2 æ­¥ã€‘æ£€æŸ¥æ¥æ”¶é˜Ÿåˆ—æ˜¯å¦æœ‰æ•°æ®                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   spin_lock(&u->lock);                                          â”‚
â”‚   int is_empty = skb_queue_empty(&u->receive_queue);           â”‚
â”‚   spin_unlock(&u->lock);                                        â”‚
â”‚                                                                  â”‚
â”‚   if (is_empty) {                                               â”‚
â”‚       // é˜Ÿåˆ—ä¸ºç©ºï¼Œéœ€è¦ç­‰å¾…                                      â”‚
â”‚       goto wait_for_data;                                       â”‚
â”‚   }                                                             â”‚
â”‚                                                                  â”‚
â”‚   é˜Ÿåˆ—çŠ¶æ€:                                                       â”‚
â”‚   head â†’ [skb1] â†’ [skb2] â†’ [skb3]                              â”‚
â”‚          â†‘                                                      â”‚
â”‚       å°†è¦å–å‡º                                                   â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 2.1 æ­¥ã€‘å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡ç­‰å¾…                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ wait_for_data:                                                  â”‚
â”‚   DEFINE_WAIT(wait);                                            â”‚
â”‚                                                                  â”‚
â”‚   for (;;) {                                                    â”‚
â”‚       // å°†å½“å‰è¿›ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—                                   â”‚
â”‚       prepare_to_wait(&u->peer_wait, &wait, TASK_INTERRUPTIBLE);â”‚
â”‚                                                                  â”‚
â”‚       // å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®åˆ°è¾¾                                   â”‚
â”‚       if (!skb_queue_empty(&u->receive_queue))                 â”‚
â”‚           break;  // æœ‰æ•°æ®ï¼Œé€€å‡ºç­‰å¾…                            â”‚
â”‚                                                                  â”‚
â”‚       // æ£€æŸ¥æ˜¯å¦æ”¶åˆ°ä¿¡å·                                        â”‚
â”‚       if (signal_pending(current)) {                            â”‚
â”‚           err = -ERESTARTSYS;                                   â”‚
â”‚           break;                                                â”‚
â”‚       }                                                         â”‚
â”‚                                                                  â”‚
â”‚       // è¿›å…¥ç¡çœ çŠ¶æ€ â¸ï¸                                         â”‚
â”‚       schedule();  // è®©å‡º CPUï¼Œè¿›ç¨‹çŠ¶æ€: RUNNING â†’ SLEEPING    â”‚
â”‚       // ... è¢«å”¤é†’åä»è¿™é‡Œç»§ç»­æ‰§è¡Œ ...                          â”‚
â”‚   }                                                             â”‚
â”‚                                                                  â”‚
â”‚   finish_wait(&u->peer_wait, &wait);                            â”‚
â”‚   // è¿›ç¨‹çŠ¶æ€: SLEEPING â†’ RUNNING                               â”‚
â”‚                                                                  â”‚
â”‚   å”¤é†’æ—¶æœº:                                                       â”‚
â”‚   â€¢ æœ‰å®¢æˆ·ç«¯è°ƒç”¨ sendto() åï¼Œå†…æ ¸è°ƒç”¨ wake_up()                 â”‚
â”‚   â€¢ è¿›ç¨‹æ”¶åˆ°ä¿¡å· (Ctrl+C ç­‰)                                     â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 3 æ­¥ã€‘ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºç¬¬ä¸€ä¸ª sk_buff                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   spin_lock(&u->lock);                                          â”‚
â”‚   struct sk_buff *skb = skb_dequeue(&u->receive_queue);        â”‚
â”‚   spin_unlock(&u->lock);                                        â”‚
â”‚                                                                  â”‚
â”‚   å–å‡ºçš„ skb:                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚ len = 19                        â”‚                          â”‚
â”‚   â”‚ data = "Client-1 Message-1"     â”‚                          â”‚
â”‚   â”‚ cb.addr = {                     â”‚                          â”‚
â”‚   â”‚   sun_family = AF_UNIX          â”‚                          â”‚
â”‚   â”‚   sun_path = "/tmp/uds_client_1.sock" â­                   â”‚
â”‚   â”‚ }                               â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                  â”‚
â”‚   é˜Ÿåˆ—çŠ¶æ€å˜åŒ–:                                                   â”‚
â”‚   ä¹‹å‰: head â†’ [skb1] â†’ [skb2] â†’ [skb3]                        â”‚
â”‚   ä¹‹å: head â†’ [skb2] â†’ [skb3]                                 â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 4 æ­¥ã€‘æ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ç¼“å†²åŒº                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   size_t copy_len = min(skb->len, buf_size);                   â”‚
â”‚                                                                  â”‚
â”‚   // ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´                                     â”‚
â”‚   if (copy_to_user(buf, skb->data, copy_len)) {                â”‚
â”‚       err = -EFAULT;                                            â”‚
â”‚       goto out_free;                                            â”‚
â”‚   }                                                             â”‚
â”‚                                                                  â”‚
â”‚   æ‹·è´ç»“æœ:                                                       â”‚
â”‚   ç”¨æˆ·ç¼“å†²åŒº: "Client-1 Message-1"                              â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 5 æ­¥ã€‘æ‹·è´å‘é€è€…åœ°å€åˆ°ç”¨æˆ·ç©ºé—´ â­â­â­ å…³é”®ï¼                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   // ä» sk_buff çš„æ§åˆ¶ä¿¡æ¯ä¸­è·å–å‘é€è€…åœ°å€                        â”‚
â”‚   struct sockaddr_un *sender_addr = UNIXCB(skb).addr;          â”‚
â”‚                                                                  â”‚
â”‚   // æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„ src_addr å‚æ•°                              â”‚
â”‚   if (src_addr) {                                               â”‚
â”‚       int addr_len = sizeof(struct sockaddr_un);                â”‚
â”‚       if (copy_to_user(src_addr, sender_addr, addr_len)) {     â”‚
â”‚           err = -EFAULT;                                        â”‚
â”‚           goto out_free;                                        â”‚
â”‚       }                                                         â”‚
â”‚       // æ›´æ–°åœ°å€é•¿åº¦                                            â”‚
â”‚       put_user(addr_len, addrlen);                              â”‚
â”‚   }                                                             â”‚
â”‚                                                                  â”‚
â”‚   â­ è¿™å°±æ˜¯åº”ç”¨å±‚èƒ½è·å– clientAddr çš„åŸç†ï¼                        â”‚
â”‚                                                                  â”‚
â”‚   æ‹·è´ç»“æœ:                                                       â”‚
â”‚   src_addr->sun_family = AF_UNIX                                â”‚
â”‚   src_addr->sun_path = "/tmp/uds_client_1.sock"                â”‚
â”‚   *addrlen = 110                                                â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 6 æ­¥ã€‘é‡Šæ”¾ sk_buff                                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ out_free:                                                       â”‚
â”‚   kfree_skb(skb);  // é‡Šæ”¾å†…æ ¸å†…å­˜                              â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ã€ç¬¬ 7 æ­¥ã€‘è¿”å›ç”¨æˆ·ç©ºé—´                                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   return copy_len;  // è¿”å›æ¥æ”¶åˆ°çš„å­—èŠ‚æ•°: 19                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 åº”ç”¨å±‚è·å–ç»“æœ

```cpp
// recvfrom() è¿”å›å

std::string receivedMsg = "Client-1 Message-1";  // âœ… ä»ç¼“å†²åŒºæ‹·è´
sockaddr_un clientAddr = {
    .sun_family = AF_UNIX,
    .sun_path = "/tmp/uds_client_1.sock"  // â­ ä» sk_buff æ‹·è´
};

// ç°åœ¨å¯ä»¥çŸ¥é“æ¶ˆæ¯æ¥è‡ªå“ªä¸ªå®¢æˆ·ç«¯äº†ï¼
std::cout << "Received from: " << clientAddr.sun_path << "\n";
// è¾“å‡º: Received from: /tmp/uds_client_1.sock
```

---

## 7. å®¢æˆ·ç«¯åœ°å€è¯†åˆ«æœºåˆ¶

### 7.1 æ ¸å¿ƒåŸç†

```
å‘é€æ—¶ä¿å­˜åœ°å€ â†’ å†…æ ¸é˜Ÿåˆ—ä¼ é€’ â†’ æ¥æ”¶æ—¶æ¢å¤åœ°å€
```

### 7.2 å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Client-1 å‘é€æ¶ˆæ¯                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  sendto(fd, "Hello", 5, 0, server_addr, addrlen)             â”‚
â”‚                                                               â”‚
â”‚  å†…æ ¸æ“ä½œ:                                                    â”‚
â”‚  1. è·å– Client-1 çš„ unix_sock                                â”‚
â”‚     u_sender->path = "/tmp/uds_client_1.sock"  â­            â”‚
â”‚                                                               â”‚
â”‚  2. åˆ†é… sk_buff                                              â”‚
â”‚     skb = alloc_skb(...)                                     â”‚
â”‚                                                               â”‚
â”‚  3. æ‹·è´æ•°æ®                                                  â”‚
â”‚     skb->data = "Hello"                                      â”‚
â”‚     skb->len = 5                                             â”‚
â”‚                                                               â”‚
â”‚  4. â­â­â­ ä¿å­˜å‘é€è€…åœ°å€åˆ° sk_buff â­â­â­                        â”‚
â”‚     UNIXCB(skb).addr = &u_sender->addr;                      â”‚
â”‚     // ä¹Ÿå°±æ˜¯:                                                â”‚
â”‚     // skb->cb.addr.sun_family = AF_UNIX                     â”‚
â”‚     // skb->cb.addr.sun_path = "/tmp/uds_client_1.sock"     â”‚
â”‚                                                               â”‚
â”‚  5. åŠ å…¥ Server æ¥æ”¶é˜Ÿåˆ—                                      â”‚
â”‚     skb_queue_tail(&server->receive_queue, skb);             â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Server æ¥æ”¶é˜Ÿåˆ—çŠ¶æ€                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  receive_queue:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ [sk_buff]                            â”‚                   â”‚
â”‚  â”‚   data: "Hello"                      â”‚                   â”‚
â”‚  â”‚   len: 5                             â”‚                   â”‚
â”‚  â”‚   cb.addr: {                         â”‚                   â”‚
â”‚  â”‚     sun_family: AF_UNIX              â”‚                   â”‚
â”‚  â”‚     sun_path: "/tmp/uds_client_1.sock" â­               â”‚
â”‚  â”‚   }                                  â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Server æ¥æ”¶æ¶ˆæ¯                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  recvfrom(fd, buf, len, 0, &client_addr, &addrlen)           â”‚
â”‚                                                               â”‚
â”‚  å†…æ ¸æ“ä½œ:                                                    â”‚
â”‚  1. ä»é˜Ÿåˆ—å–å‡º sk_buff                                        â”‚
â”‚     skb = skb_dequeue(&server->receive_queue);               â”‚
â”‚                                                               â”‚
â”‚  2. æ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´                                        â”‚
â”‚     copy_to_user(buf, skb->data, skb->len);                  â”‚
â”‚     // buf = "Hello"                                         â”‚
â”‚                                                               â”‚
â”‚  3. â­â­â­ æ‹·è´å‘é€è€…åœ°å€åˆ°ç”¨æˆ·ç©ºé—´ â­â­â­                        â”‚
â”‚     copy_to_user(&client_addr,                               â”‚
â”‚                  UNIXCB(skb).addr,                           â”‚
â”‚                  sizeof(sockaddr_un));                       â”‚
â”‚     // client_addr.sun_path = "/tmp/uds_client_1.sock" â­    â”‚
â”‚                                                               â”‚
â”‚  4. é‡Šæ”¾ sk_buff                                              â”‚
â”‚     kfree_skb(skb);                                          â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Server åº”ç”¨å±‚è·å–ç»“æœ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  std::string receivedMsg = "Hello";                          â”‚
â”‚  sockaddr_un clientAddr = {                                  â”‚
â”‚      .sun_family = AF_UNIX,                                  â”‚
â”‚      .sun_path = "/tmp/uds_client_1.sock"  â­                â”‚
â”‚  };                                                          â”‚
â”‚                                                               â”‚
â”‚  // ç°åœ¨å¯ä»¥å›å¤ç»™æ­£ç¡®çš„å®¢æˆ·ç«¯                                 â”‚
â”‚  sendto(fd, "ACK", 3, 0, &clientAddr, sizeof(clientAddr));   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 å…³é”®ä»£ç ç‰‡æ®µ

#### å‘é€æ—¶ä¿å­˜åœ°å€ (å†…æ ¸ä»£ç )

```c
// net/unix/af_unix.c

static int unix_dgram_sendmsg(struct socket *sock, 
                              struct msghdr *msg, 
                              size_t len)
{
    struct sock *sk = sock->sk;
    struct unix_sock *u = unix_sk(sk);
    
    // ... åˆ†é… skb ...
    
    // â­ ä¿å­˜å‘é€è€…åœ°å€
    UNIXCB(skb).addr = &u->addr;  // u->addr åŒ…å« sun_path
    
    // ... å‘é€åˆ°æ¥æ”¶é˜Ÿåˆ— ...
}
```

#### æ¥æ”¶æ—¶æ¢å¤åœ°å€ (å†…æ ¸ä»£ç )

```c
// net/unix/af_unix.c

static int unix_dgram_recvmsg(struct socket *sock,
                              struct msghdr *msg,
                              size_t size,
                              int flags)
{
    struct sk_buff *skb;
    
    // ... ä»é˜Ÿåˆ—å–å‡º skb ...
    
    // â­ æ¢å¤å‘é€è€…åœ°å€
    if (msg->msg_name) {
        struct sockaddr_un *sunaddr = msg->msg_name;
        sunaddr->sun_family = AF_UNIX;
        
        // ä» sk_buff æ‹·è´ sun_path
        if (UNIXCB(skb).addr) {
            memcpy(sunaddr->sun_path, 
                   UNIXCB(skb).addr->sun_path,
                   UNIX_PATH_MAX);
        }
        
        msg->msg_namelen = sizeof(struct sockaddr_un);
    }
    
    // ... æ‹·è´æ•°æ® ...
}
```

### 7.4 å¤šå®¢æˆ·ç«¯è¯†åˆ«ç¤ºä¾‹

```
æ—¶é—´è½´:

T1: Client-1 sendto("Msg-1") 
    â†’ skb1.cb.addr = "/tmp/uds_client_1.sock"
    â†’ Server queue: [skb1]

T2: Client-2 sendto("Msg-2")
    â†’ skb2.cb.addr = "/tmp/uds_client_2.sock"
    â†’ Server queue: [skb1][skb2]

T3: Client-3 sendto("Msg-3")
    â†’ skb3.cb.addr = "/tmp/uds_client_3.sock"
    â†’ Server queue: [skb1][skb2][skb3]

T4: Server recvfrom()
    â†’ å–å‡º skb1
    â†’ msg = "Msg-1"
    â†’ client_addr = "/tmp/uds_client_1.sock" â­
    â†’ Server queue: [skb2][skb3]

T5: Server recvfrom()
    â†’ å–å‡º skb2
    â†’ msg = "Msg-2"
    â†’ client_addr = "/tmp/uds_client_2.sock" â­
    â†’ Server queue: [skb3]

T6: Server recvfrom()
    â†’ å–å‡º skb3
    â†’ msg = "Msg-3"
    â†’ client_addr = "/tmp/uds_client_3.sock" â­
    â†’ Server queue: []
```

**ç»“è®º**: æ¯ä¸ªæ¶ˆæ¯éƒ½æºå¸¦è‡ªå·±çš„å‘é€è€…åœ°å€ï¼ŒæœåŠ¡ç«¯å¯ä»¥å‡†ç¡®è¯†åˆ«æ¯æ¡æ¶ˆæ¯çš„æ¥æºã€‚

---

## 8. å®Œæ•´äº¤äº’ç¤ºä¾‹

### 8.1 åœºæ™¯æè¿°

- **æœåŠ¡ç«¯**: `/tmp/uds_server.sock`
- **å®¢æˆ·ç«¯ 1**: `/tmp/uds_client_1.sock`
- **å®¢æˆ·ç«¯ 2**: `/tmp/uds_client_2.sock`

### 8.2 è¯¦ç»†æ—¶åºå›¾

```
Client-1          Client-2          Server            å†…æ ¸
â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€

  â”‚                 â”‚                  â”‚
  â”‚ sendTo("C1-M1", server_addr)      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
  â”‚                 â”‚                  â”‚  socket(AF_UNIX)
  â”‚                 â”‚                  â”‚  bind("/tmp/uds_server.sock")
  â”‚                 â”‚                  â”‚  receiveFrom() â¸ï¸ é˜»å¡ç­‰å¾…
  â”‚                 â”‚                  â”‚
  â”‚ sys_sendto() â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â†’ å†…æ ¸
  â”‚                 â”‚                  â”‚      1. æŸ¥æ‰¾ sender: client_1
  â”‚                 â”‚                  â”‚      2. æŸ¥æ‰¾ receiver: server
  â”‚                 â”‚                  â”‚      3. alloc skb1
  â”‚                 â”‚                  â”‚      4. skb1->data = "C1-M1"
  â”‚                 â”‚                  â”‚      5. â­ skb1->cb.addr = client_1
  â”‚                 â”‚                  â”‚      6. skb_queue_tail(server->queue, skb1)
  â”‚                 â”‚                  â”‚      7. wake_up(server->peer_wait)
  â”‚                 â”‚                  â”‚  â† â”€ â”€ â”€ â”€ â”€ â”€ â”€
  â”‚                 â”‚                  â”‚  è¢«å”¤é†’ï¼
  â”‚                 â”‚                  â”‚  sys_recvfrom()
  â”‚                 â”‚                  â”œâ”€â”€â”€â†’ å†…æ ¸
  â”‚                 â”‚                  â”‚      1. skb = dequeue(server->queue)
  â”‚                 â”‚                  â”‚      2. copy_to_user(buf, skb->data)
  â”‚                 â”‚                  â”‚      3. â­ copy_to_user(addr, skb->cb.addr)
  â”‚                 â”‚                  â”‚  â† â”€ â”€ â”€ â”€ â”€ â”€ â”€
  â”‚                 â”‚                  â”‚  msg = "C1-M1"
  â”‚                 â”‚                  â”‚  client_addr = "/tmp/uds_client_1.sock" â­
  â”‚                 â”‚                  â”‚
  â”‚                 â”‚                  â”‚  å¤„ç†æ¶ˆæ¯...
  â”‚                 â”‚                  â”‚  response = "ACK: C1-M1"
  â”‚                 â”‚                  â”‚
  â”‚                 â”‚                  â”‚  sendTo(response, client_addr)
  â”‚                 â”‚                  â”œâ”€â”€â”€â†’ å†…æ ¸
  â”‚                 â”‚                  â”‚      1. æŸ¥æ‰¾ receiver: client_1
  â”‚                 â”‚                  â”‚      2. alloc skb_resp
  â”‚                 â”‚                  â”‚      3. skb_resp->data = "ACK: C1-M1"
  â”‚                 â”‚                  â”‚      4. â­ skb_resp->cb.addr = server
  â”‚                 â”‚                  â”‚      5. skb_queue_tail(client_1->queue, skb_resp)
  â”‚                 â”‚                  â”‚      6. wake_up(client_1->peer_wait)
  â”‚  â† â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”¤
  â”‚  (å¦‚æœ Client-1 åœ¨ receiveFrom() é˜»å¡)
  â”‚                 â”‚                  â”‚
  â”‚                 â”‚                  â”‚  receiveFrom() â¸ï¸ ç»§ç»­ç­‰å¾…
  â”‚                 â”‚                  â”‚
  â”‚                 sendTo("C2-M1", server_addr)
  â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
  â”‚                 â”‚                  â”‚
  â”‚                 sys_sendto() â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â†’ å†…æ ¸
  â”‚                 â”‚                  â”‚      ... ç±»ä¼¼æµç¨‹ ...
  â”‚                 â”‚                  â”‚      â­ skb2->cb.addr = client_2
  â”‚                 â”‚                  â”‚  â† â”€ â”€ â”€ â”€ â”€ â”€ â”€
  â”‚                 â”‚                  â”‚  è¢«å”¤é†’ï¼
  â”‚                 â”‚                  â”‚  msg = "C2-M1"
  â”‚                 â”‚                  â”‚  client_addr = "/tmp/uds_client_2.sock" â­
  â”‚                 â”‚                  â”‚
  â”‚                 â”‚                  â”‚  sendTo("ACK: C2-M1", client_addr)
  â”‚                 â”‚  â† â”€ â”€ â”€ â”€ â”€ â”€ â”€â”¤
  â”‚                 â”‚                  â”‚
```

### 8.3 æœåŠ¡ç«¯æ—¥å¿—è¾“å‡º

```
[SERVER] ğŸš€ Server starting...
[SERVER] ğŸ“¡ Listening on: /tmp/uds_server.sock
[SERVER] â³ Waiting for messages...

[SERVER] ğŸ“¨ [Message 1] Received from: /tmp/uds_client_1.sock
[SERVER]    Content: "Client-1 Message-1"
[SERVER] ğŸ“¤ [Message 1] Replied to: /tmp/uds_client_1.sock
[SERVER]    Response: "ACK: Client-1 Message-1" âœ…

[SERVER] ğŸ“¨ [Message 2] Received from: /tmp/uds_client_2.sock
[SERVER]    Content: "Client-2 Message-1"
[SERVER] ğŸ“¤ [Message 2] Replied to: /tmp/uds_client_2.sock
[SERVER]    Response: "ACK: Client-2 Message-1" âœ…

[SERVER] ğŸ“¨ [Message 3] Received from: /tmp/uds_client_1.sock
[SERVER]    Content: "Client-1 Message-2"
[SERVER] ğŸ“¤ [Message 3] Replied to: /tmp/uds_client_1.sock
[SERVER]    Response: "ACK: Client-1 Message-2" âœ…
```

**è§‚å¯Ÿ**: æœåŠ¡ç«¯èƒ½å‡†ç¡®è¯†åˆ«æ¯æ¡æ¶ˆæ¯çš„å‘é€è€…ï¼Œå¹¶å›å¤åˆ°æ­£ç¡®çš„å®¢æˆ·ç«¯ã€‚

---

## 9. å†…æ ¸æ•°æ®ç»“æ„

### 9.1 å®Œæ•´æ•°æ®ç»“æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç©ºé—´ (User Space)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  int fd = 3;  â† æ–‡ä»¶æè¿°ç¬¦                                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                   é€šè¿‡ fd ç´¢å¼•
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å†…æ ¸ç©ºé—´ (Kernel Space)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦è¡¨ (current->files->fd_array[3])                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ struct file  â”‚                                               â”‚
â”‚  â”‚   f_op â”€â”€â”€â”€â”€â”€â”¼â”€â†’ socket_file_ops                             â”‚
â”‚  â”‚   private_data â”€â†’ struct socket                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â†“                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ struct socket                   â”‚                            â”‚
â”‚  â”‚   type = SOCK_DGRAM             â”‚                            â”‚
â”‚  â”‚   state = SS_BOUND              â”‚                            â”‚
â”‚  â”‚   ops â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ unix_dgram_ops           â”‚
â”‚  â”‚   sk â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                          â”‚
â”‚                                       â”‚                          â”‚
â”‚                                       â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ struct sock (åŸºç¡€ socket ç»“æ„)                            â”‚  â”‚
â”‚  â”‚   sk_family = AF_UNIX                                     â”‚  â”‚
â”‚  â”‚   sk_type = SOCK_DGRAM                                    â”‚  â”‚
â”‚  â”‚   sk_protocol = 0                                         â”‚  â”‚
â”‚  â”‚   sk_receive_queue â”€â”€â”€â†’ (é€šç”¨æ¥æ”¶é˜Ÿåˆ—ï¼ŒUDS ä¸ç”¨)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚ ç»§æ‰¿                                                   â”‚
â”‚         â†“                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ struct unix_sock (Unix socket ç‰¹å®šç»“æ„)                   â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚   addr â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚ â”‚  â”‚
â”‚  â”‚   â”‚ struct sockaddr_un {                â”‚               â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   sun_family = AF_UNIX              â”‚               â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   sun_path = "/tmp/uds_server.sock" â”‚  â­ ç»‘å®šåœ°å€  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚ }                                   â”‚               â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ â”‚  â”‚
â”‚  â”‚                                                          â”‚ â”‚  â”‚
â”‚  â”‚   path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚ struct path {                â”‚                   â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   dentry â”€â”€â†’ dentry in /tmp/ â”‚  â† æ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹   â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   mnt â”€â”€â”€â”€â”€â”€â†’ vfsmount       â”‚                   â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚ }                            â”‚                   â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚ â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   receive_queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚ struct sk_buff_head {                       â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   next â”€â”€â†’ [skb1] â”€â”€â†’ [skb2] â”€â”€â†’ [skb3]    â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   prev â”€â”€â†’ [skb3]                           â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   qlen = 3                                  â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   lock (spinlock_t)                         â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚ }                                           â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚                â”‚                                   â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚                â†“                                   â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚ struct sk_buff (æ¶ˆæ¯ 1)                     â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   next â”€â”€â†’ [skb2]                           â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   data â”€â”€â†’ "Client-1 Message-1"             â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   len = 19                                  â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   cb[48] = {                                â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚     addr â”€â”€â†’ {                              â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚       sun_family = AF_UNIX                  â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚       sun_path = "/tmp/uds_client_1.sock"  â”‚ â­  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚     }                                       â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   }                                         â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   peer_wait â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚ wait_queue_head_t                          â”‚â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   wait_list â”€â”€â†’ [task1] â”€â”€â†’ [task2]       â”‚â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚   (é˜»å¡åœ¨ recvfrom çš„è¿›ç¨‹)                  â”‚â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚                                                  â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   lock (spinlock_t)  â† ä¿æŠ¤é˜Ÿåˆ—æ“ä½œ              â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚                                                  â”‚ â”‚  â”‚  â”‚ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚  â”‚
â”‚                                                         â”‚  â”‚ â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”´â”€â”´â”€â”€â”˜
```

### 9.2 å…³é”®å­—æ®µè¯´æ˜

#### struct unix_sock

```c
struct unix_sock {
    struct sock sk;                    // åŸºç¡€ socket ç»“æ„
    
    struct sockaddr_un addr;           // â­ æœ¬åœ°ç»‘å®šåœ°å€
    struct path path;                  // æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ (dentry + mount)
    
    struct mutex bindlock;             // bind æ“ä½œé”
    
    struct sock *peer;                 // è¿æ¥æ¨¡å¼ä¸‹çš„å¯¹ç«¯
    struct list_head link;             // å…¨å±€ socket é“¾è¡¨
    
    atomic_long_t inflight;            // ä¼ è¾“ä¸­çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡
    
    spinlock_t lock;                   // â­ æ¥æ”¶é˜Ÿåˆ—é”
    
    wait_queue_head_t peer_wait;       // â­ ç­‰å¾…é˜Ÿåˆ—
    
    struct sk_buff_head receive_queue; // â­ æ¥æ”¶é˜Ÿåˆ— (DGRAM æ¨¡å¼)
};
```

#### struct sk_buff

```c
struct sk_buff {
    struct sk_buff *next;              // é“¾è¡¨æŒ‡é’ˆ
    struct sk_buff *prev;
    
    ktime_t tstamp;                    // æ—¶é—´æˆ³
    
    struct sock *sk;                   // æ‰€å± socket
    struct net_device *dev;            // ç½‘ç»œè®¾å¤‡ (UDS ä¸º NULL)
    
    unsigned char *head;               // ç¼“å†²åŒºå¤´
    unsigned char *data;               // â­ æ•°æ®èµ·å§‹
    unsigned char *tail;               // æ•°æ®å°¾
    unsigned char *end;                // ç¼“å†²åŒºå°¾
    
    unsigned int len;                  // â­ æ•°æ®é•¿åº¦
    unsigned int data_len;
    
    char cb[48] __aligned(8);          // â­ æ§åˆ¶ä¿¡æ¯ç¼“å†²åŒº
    
    // ... å…¶ä»–å­—æ®µ
};

// Unix socket çš„ cb ç”¨æ³•
#define UNIXCB(skb)  (*(struct unix_skb_parms *)&((skb)->cb))

struct unix_skb_parms {
    struct pid *pid;                   // å‘é€è¿›ç¨‹ PID
    kuid_t uid;                        // å‘é€è¿›ç¨‹ UID
    kgid_t gid;                        // å‘é€è¿›ç¨‹ GID
    struct scm_fp_list *fp;            // ä¼ é€’çš„æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨
    u32 secid;                         // å®‰å…¨ä¸Šä¸‹æ–‡ ID
    struct sockaddr_un *addr;          // â­â­â­ å‘é€è€…åœ°å€
};
```

---

## 10. æ€§èƒ½åˆ†æ

### 10.1 å»¶è¿Ÿåˆ†æ

#### å•æ¬¡æ¶ˆæ¯å¾€è¿”æ—¶å»¶

```
Client sendto()                     â‰ˆ 1-5 Î¼s  (ç³»ç»Ÿè°ƒç”¨å¼€é”€)
    â†“
å†…æ ¸å¤„ç†:
  - æŸ¥æ‰¾ socket                     â‰ˆ 0.1 Î¼s (å“ˆå¸Œè¡¨æŸ¥æ‰¾)
  - åˆ†é… sk_buff                    â‰ˆ 0.5 Î¼s (å†…å­˜åˆ†é…)
  - æ‹·è´æ•°æ® (ç”¨æˆ·â†’å†…æ ¸)            â‰ˆ 0.1 Î¼s (4KB ä»¥å†…)
  - åŠ å…¥é˜Ÿåˆ—                        â‰ˆ 0.1 Î¼s (é“¾è¡¨æ“ä½œ)
  - å”¤é†’è¿›ç¨‹                        â‰ˆ 0.5 Î¼s (è°ƒåº¦å™¨æ“ä½œ)
    â†“
Server recvfrom()                   â‰ˆ 1-5 Î¼s  (ç³»ç»Ÿè°ƒç”¨å¼€é”€)
    â†“
å†…æ ¸å¤„ç†:
  - å–å‡º sk_buff                    â‰ˆ 0.1 Î¼s
  - æ‹·è´æ•°æ® (å†…æ ¸â†’ç”¨æˆ·)            â‰ˆ 0.1 Î¼s
  - é‡Šæ”¾ sk_buff                    â‰ˆ 0.2 Î¼s
    â†“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»å»¶è¿Ÿ (å•ç¨‹):                      â‰ˆ 3-12 Î¼s
å¾€è¿”å»¶è¿Ÿ (RTT):                     â‰ˆ 6-24 Î¼s
```

**å¯¹æ¯”**:
- TCP loopback (127.0.0.1): 50-100 Î¼s
- å…±äº«å†…å­˜ + ä¿¡å·é‡: 1-3 Î¼s
- Unix Domain Socket: 6-24 Î¼s âœ… å¹³è¡¡æ€§èƒ½å’Œæ˜“ç”¨æ€§

### 10.2 ååé‡åˆ†æ

#### ç†è®ºååé‡

```
å‡è®¾:
- æ¶ˆæ¯å¤§å°: 1 KB
- å•ç¨‹å»¶è¿Ÿ: 10 Î¼s
- æ— é˜»å¡æƒ…å†µ

ååé‡ = 1 KB / 10 Î¼s = 100 MB/s (å•å®¢æˆ·ç«¯)

å¤šå®¢æˆ·ç«¯:
- 3 ä¸ªå®¢æˆ·ç«¯å¹¶å‘: â‰ˆ 200-250 MB/s
  (å—é™äºå†…æ ¸é”ç«äº‰å’Œè°ƒåº¦å¼€é”€)
```

#### å®é™…æµ‹é‡ (åŸºå‡†æµ‹è¯•)

```bash
# æµ‹è¯•å·¥å…·: test/posix/ipc/multi_process_test
# ç¡¬ä»¶: Intel i7, 16GB RAM

# å•å®¢æˆ·ç«¯, 1KB æ¶ˆæ¯, 10000 æ¬¡
ååé‡: ~85 MB/s
å»¶è¿Ÿ: ~11.7 Î¼s (å¹³å‡)

# 3 å®¢æˆ·ç«¯, 1KB æ¶ˆæ¯, æ¯å®¢æˆ·ç«¯ 10000 æ¬¡
ååé‡: ~210 MB/s
å»¶è¿Ÿ: ~14.2 Î¼s (å¹³å‡, åŒ…å«é˜Ÿåˆ—ç­‰å¾…)
```

### 10.3 èµ„æºæ¶ˆè€—

#### å†…å­˜æ¶ˆè€—

```
æ¯ä¸ª socket:
  struct socket:        â‰ˆ 256 bytes
  struct unix_sock:     â‰ˆ 512 bytes
  æ¥æ”¶é˜Ÿåˆ—å¤´:            â‰ˆ 64 bytes
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ€»è®¡:                 â‰ˆ 832 bytes

æ¯æ¡æ¶ˆæ¯ (sk_buff):
  sk_buff ç»“æ„:         â‰ˆ 256 bytes
  æ•°æ®ç¼“å†²åŒº:            â‰ˆ æ¶ˆæ¯å¤§å° + å¯¹é½
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ç¤ºä¾‹ (1KB æ¶ˆæ¯):      â‰ˆ 1280 bytes

é˜Ÿåˆ—ä¸­ 100 æ¡æ¶ˆæ¯:      â‰ˆ 128 KB
```

#### CPU æ¶ˆè€—

```
ä¸»è¦å¼€é”€:
1. ç³»ç»Ÿè°ƒç”¨ (ç”¨æˆ·æ€â†”å†…æ ¸æ€åˆ‡æ¢)    30-40%
2. æ•°æ®æ‹·è´ (ç”¨æˆ·ç©ºé—´â†”å†…æ ¸ç©ºé—´)    20-30%
3. é”ç«äº‰ (spinlock)               10-20%
4. å†…å­˜åˆ†é…/é‡Šæ”¾                    10-15%
5. è¿›ç¨‹è°ƒåº¦                         10-20%
```

### 10.4 ä¼˜åŒ–å»ºè®®

#### å‡å°‘ç³»ç»Ÿè°ƒç”¨

```cpp
// âŒ æ¯æ¬¡å‘é€/æ¥æ”¶ä¸€æ¡æ¶ˆæ¯
for (int i = 0; i < 1000; i++) {
    sendto(...);  // 1000 æ¬¡ç³»ç»Ÿè°ƒç”¨
}

// âœ… æ‰¹é‡å‘é€
std::vector<std::string> batch;
for (int i = 0; i < 1000; i++) {
    batch.push_back(...);
    if (batch.size() >= 10) {
        sendto_batch(batch);  // 100 æ¬¡ç³»ç»Ÿè°ƒç”¨
        batch.clear();
    }
}
```

#### ä½¿ç”¨æ›´å¤§çš„æ¶ˆæ¯

```
å°æ¶ˆæ¯ (100 bytes):
  å¼€é”€/æ¶ˆæ¯ â‰ˆ 10 Î¼s
  ååé‡ â‰ˆ 10 MB/s

å¤§æ¶ˆæ¯ (64 KB):
  å¼€é”€/æ¶ˆæ¯ â‰ˆ 15 Î¼s
  ååé‡ â‰ˆ 4 GB/s  âœ…
```

#### éé˜»å¡æ¨¡å¼ + epoll

```cpp
// è®¾ç½®éé˜»å¡
int flags = fcntl(fd, F_GETFL, 0);
fcntl(fd, F_SETFL, flags | O_NONBLOCK);

// ä½¿ç”¨ epoll ç›‘å¬å¤šä¸ª socket
int epoll_fd = epoll_create1(0);
epoll_ctl(epoll_fd, EPOLL_CTL_ADD, server_fd, &ev);

while (true) {
    int n = epoll_wait(epoll_fd, events, MAX_EVENTS, -1);
    for (int i = 0; i < n; i++) {
        // æœ‰æ•°æ®å¯è¯»ï¼Œç«‹å³å¤„ç†
        recvfrom(...);
    }
}
```

---

## 11. æ€»ç»“

### 11.1 æ ¸å¿ƒæµç¨‹å›é¡¾

```
1. åˆå§‹åŒ–é˜¶æ®µ
   â”œâ”€ socket()  â†’ åˆ›å»º socket å’Œ unix_sock
   â””â”€ bind()    â†’ ç»‘å®šåˆ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„

2. å‘é€æ¶ˆæ¯
   â”œâ”€ sendto()  â†’ ç³»ç»Ÿè°ƒç”¨
   â”œâ”€ æŸ¥æ‰¾å‘é€è€…å’Œæ¥æ”¶è€…çš„ unix_sock
   â”œâ”€ åˆ†é… sk_buff
   â”œâ”€ æ‹·è´æ•°æ®åˆ° sk_buff
   â”œâ”€ â­ ä¿å­˜å‘é€è€…åœ°å€åˆ° sk_buff->cb
   â”œâ”€ åŠ å…¥æ¥æ”¶è€…çš„æ¥æ”¶é˜Ÿåˆ—
   â””â”€ å”¤é†’æ¥æ”¶è€…è¿›ç¨‹

3. æ¥æ”¶æ¶ˆæ¯
   â”œâ”€ recvfrom() â†’ ç³»ç»Ÿè°ƒç”¨
   â”œâ”€ æ£€æŸ¥æ¥æ”¶é˜Ÿåˆ— (ç©ºåˆ™é˜»å¡ç­‰å¾…)
   â”œâ”€ å–å‡ºç¬¬ä¸€ä¸ª sk_buff
   â”œâ”€ æ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç¼“å†²åŒº
   â”œâ”€ â­ æ‹·è´å‘é€è€…åœ°å€åˆ°ç”¨æˆ·å‚æ•°
   â”œâ”€ é‡Šæ”¾ sk_buff
   â””â”€ è¿”å›ç”¨æˆ·ç©ºé—´

4. å¤šå®¢æˆ·ç«¯é˜Ÿåˆ—
   â”œâ”€ ä½¿ç”¨ sk_buff_head é“¾è¡¨
   â”œâ”€ spinlock ä¿æŠ¤å¹¶å‘è®¿é—®
   â”œâ”€ FIFO é¡ºåº
   â””â”€ æ¯ä¸ª sk_buff ç‹¬ç«‹ä¿å­˜å‘é€è€…åœ°å€
```

### 11.2 å…³é”®æŠ€æœ¯ç‚¹

| æŠ€æœ¯ç‚¹ | å®ç°æ–¹å¼ | ä½œç”¨ |
|--------|----------|------|
| **åœ°å€è¯†åˆ«** | sk_buff->cb ä¿å­˜å‘é€è€…åœ°å€ | æœåŠ¡ç«¯èƒ½è¯†åˆ«æ¶ˆæ¯æ¥æº |
| **é˜Ÿåˆ—ç®¡ç†** | sk_buff_head é“¾è¡¨ + spinlock | å¤šå®¢æˆ·ç«¯æ¶ˆæ¯æœ‰åºæ’é˜Ÿ |
| **é˜»å¡ç­‰å¾…** | wait_queue_head_t | æ— æ¶ˆæ¯æ—¶è¿›ç¨‹ç¡çœ  |
| **è¿›ç¨‹å”¤é†’** | wake_up_interruptible() | æ¶ˆæ¯åˆ°è¾¾æ—¶å”¤é†’æ¥æ”¶è€… |
| **æ•°æ®ä¼ é€’** | ä¸¤æ¬¡æ‹·è´ (ç”¨æˆ·â†’å†…æ ¸â†’ç”¨æˆ·) | å®‰å…¨éš”ç¦» |
| **è·¯å¾„æŸ¥æ‰¾** | dentry + inode æ˜ å°„ | å¿«é€Ÿå®šä½ç›®æ ‡ socket |

### 11.3 é€‚ç”¨åœºæ™¯

âœ… **é€‚åˆ**:
- æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡
- éœ€è¦å¯é æ¶ˆæ¯ä¼ é€’
- å¤šå®¢æˆ·ç«¯-å•æœåŠ¡ç«¯æ¶æ„
- å¯¹å»¶è¿Ÿè¦æ±‚ä¸æç«¯ (< 100 Î¼s å¯æ¥å—)

âŒ **ä¸é€‚åˆ**:
- è·¨ä¸»æœºé€šä¿¡ (ä½¿ç”¨ TCP/IP)
- æä½å»¶è¿Ÿè¦æ±‚ (< 1 Î¼s, è€ƒè™‘å…±äº«å†…å­˜)
- å¤§é‡å°æ¶ˆæ¯é«˜é¢‘ä¼ è¾“ (è€ƒè™‘æ‰¹å¤„ç†æˆ–å…±äº«å†…å­˜)

### 11.4 ä¸å…¶ä»– IPC æ–¹å¼å¯¹æ¯”

| IPC æ–¹å¼ | å»¶è¿Ÿ | ååé‡ | æ˜“ç”¨æ€§ | æ¶ˆæ¯è¾¹ç•Œ |
|----------|------|--------|--------|----------|
| **Unix Domain Socket** | 10-20 Î¼s | 100-200 MB/s | â­â­â­â­ | âœ… ä¿æŒ |
| TCP Loopback | 50-100 Î¼s | 50-100 MB/s | â­â­â­â­â­ | âŒ æµå¼ |
| å…±äº«å†…å­˜ + Semaphore | 1-3 Î¼s | 1-5 GB/s | â­â­ | âŒ éœ€è‡ªè¡Œå®ç° |
| ç®¡é“ (Pipe) | 5-15 Î¼s | 50-100 MB/s | â­â­â­ | âŒ æµå¼ |
| æ¶ˆæ¯é˜Ÿåˆ— (POSIX) | 20-50 Î¼s | 20-50 MB/s | â­â­â­ | âœ… ä¿æŒ |

---

## é™„å½•

### A. ç›¸å…³ç³»ç»Ÿè°ƒç”¨æ‰‹å†Œ

```bash
man 2 socket
man 2 bind
man 2 sendto
man 2 recvfrom
man 7 unix
```

### B. å†…æ ¸æºç ä½ç½®

```
net/unix/af_unix.c          # Unix socket æ ¸å¿ƒå®ç°
include/linux/skbuff.h      # sk_buff å®šä¹‰
include/net/af_unix.h       # Unix socket å¤´æ–‡ä»¶
net/core/sock.c             # é€šç”¨ socket å®ç°
```

### C. è°ƒè¯•å·¥å…·

```bash
# æŸ¥çœ‹ socket æ–‡ä»¶
ls -l /tmp/*.sock

# ç›‘æ§ socket æ´»åŠ¨
strace -e trace=socket,bind,sendto,recvfrom ./client

# æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨å»¶è¿Ÿ
perf trace -s ./server

# æŸ¥çœ‹å†…æ ¸å‡½æ•°è°ƒç”¨
sudo bpftrace -e 'kprobe:unix_dgram_sendmsg { @[comm] = count(); }'
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-21  
**ä½œè€…**: Zero Copy Framework Team


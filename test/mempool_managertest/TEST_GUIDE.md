# MemPoolManager æµ‹è¯•æŒ‡å—

## æµ‹è¯•æ¶æ„æ›´æ–°è¯´æ˜

æœ¬æµ‹è¯•å¥—ä»¶å·²å®Œå…¨é‡å†™ï¼Œä»¥åŒ¹é… MemPoolManager çš„**åŒå…±äº«å†…å­˜æ¶æ„**ã€‚

### æ—§æ¶æ„ vs æ–°æ¶æ„

#### âŒ æ—§æ¶æ„ï¼ˆå·²åºŸå¼ƒï¼‰

```
å•ä¸€å…±äº«å†…å­˜æ®µ
â”œâ”€â”€ ç®¡ç†åŒºæ•°æ®
â””â”€â”€ æ•°æ®åŒºï¼ˆchunksï¼‰

é—®é¢˜ï¼š
- åŸºåœ°å€ä¸æ˜ç¡®
- ä½¿ç”¨ç»å¯¹æŒ‡é’ˆï¼ˆä¸æ”¯æŒå¤šè¿›ç¨‹ï¼‰
```

#### âœ… æ–°æ¶æ„ï¼ˆå½“å‰ï¼‰

```
ç®¡ç†åŒºå…±äº«å†…å­˜ (/zerocp_memory_management)
â”œâ”€â”€ MemPoolManager å®ä¾‹
â”œâ”€â”€ freeList
â”œâ”€â”€ ChunkManager Pool
â””â”€â”€ MemPool å…ƒæ•°æ®ï¼ˆRelativePointerï¼‰

æ•°æ®åŒºå…±äº«å†…å­˜ (/zerocp_memory_chunk)
â”œâ”€â”€ Chunk 1
â”œâ”€â”€ Chunk 2
â””â”€â”€ Chunk N

å…³é”®ç‰¹æ€§ï¼š
- åŒå…±äº«å†…å­˜åˆ†ç¦»ç®¡ç†
- è¿›ç¨‹æœ¬åœ°å˜é‡è®°å½•åŸºåœ°å€
- RelativePointer å­˜å‚¨ç›¸å¯¹åç§»
- å®Œå…¨æ”¯æŒå¤šè¿›ç¨‹
```

## æµ‹è¯•æ–‡ä»¶è¯´æ˜

### 1. test_mempool_manager_basic.cpp

**ç›®çš„**ï¼šéªŒè¯å•è¿›ç¨‹åœºæ™¯ä¸‹çš„åŸºæœ¬åŠŸèƒ½

**æµ‹è¯•è¦†ç›–**ï¼š
| æµ‹è¯•é¡¹ | æè¿° | éªŒè¯ç‚¹ |
|--------|------|--------|
| TEST 1 | MemPoolConfig åˆ›å»º | é…ç½®é¡¹æ­£ç¡®æ·»åŠ  |
| TEST 2 | å…±äº«å®ä¾‹åˆ›å»º | createSharedInstance æˆåŠŸ |
| TEST 3 | å†…å­˜å¤§å°è®¡ç®— | ç®¡ç†åŒº + æ•°æ®åŒº = æ€»å¤§å° |
| TEST 4 | MemPool è®¿é—® | æ‰€æœ‰ MemPool å¯è®¿é—®ä¸”é…ç½®æ­£ç¡® |
| TEST 5 | åŸºåœ°å€éªŒè¯ | åŒå…±äº«å†…å­˜åŸºåœ°å€æ­£ç¡® |
| TEST 6 | ç»Ÿè®¡ä¿¡æ¯ | printAllPoolStats æ­£å¸¸å·¥ä½œ |
| TEST 7 | å®ä¾‹é”€æ¯ | destroySharedInstance æ¸…ç†å®Œå…¨ |

**è¿è¡Œæ–¹å¼**ï¼š
```bash
./build/bin/test_mempool_manager_basic
```

**é¢„æœŸè¾“å‡º**ï¼š
```
======================================================================
MemPoolManager åŸºç¡€å•è¿›ç¨‹æµ‹è¯•
æµ‹è¯•åŒå…±äº«å†…å­˜æ¶æ„ï¼ˆç®¡ç†åŒº + æ•°æ®åŒºï¼‰
======================================================================

[TEST 1] MemPoolConfig åˆ›å»ºå’Œé…ç½®
âœ“ PASS - MemPoolConfig åˆ›å»ºå’Œé…ç½® (3ä¸ªå†…å­˜æ± é…ç½®æˆåŠŸ)

[TEST 2] å…±äº«å®ä¾‹åˆ›å»º
âœ“ PASS - å…±äº«å®ä¾‹åˆ›å»º (å®ä¾‹åˆ›å»ºå¹¶è·å–æˆåŠŸ)

...

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

### 2. test_mempool_manager_multiprocess.cpp

**ç›®çš„**ï¼šéªŒè¯å¤šè¿›ç¨‹å…±äº«å†…å­˜åœºæ™¯

**æµ‹è¯•æµç¨‹**ï¼š
```
çˆ¶è¿›ç¨‹                        å­è¿›ç¨‹
   â”‚                            â”‚
   â”œâ”€ createSharedInstance      â”‚
   â”‚  (åˆ›å»ºåŒå…±äº«å†…å­˜)           â”‚
   â”‚                            â”‚
   â”œâ”€ fork() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                            â”‚
   â”‚                            â”œâ”€ getInstanceIfInitialized
   â”‚                            â”‚  (é™„åŠ åˆ°å·²æœ‰å®ä¾‹)
   â”‚                            â”‚
   â”‚                            â”œâ”€ éªŒè¯ MemPool é…ç½®
   â”‚                            â”‚  (åº”ä¸çˆ¶è¿›ç¨‹ç›¸åŒ)
   â”‚                            â”‚
   â”‚                            â”œâ”€ éªŒè¯å†…å­˜å¤§å°
   â”‚<â”€â”€â”€â”€ exit(0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚
   â”œâ”€ waitpid (ç­‰å¾…å­è¿›ç¨‹)
   â”‚
   â”œâ”€ éªŒè¯å­è¿›ç¨‹æˆåŠŸ
   â”‚
   â””â”€ destroySharedInstance
```

**å…³é”®éªŒè¯ç‚¹**ï¼š
1. âœ… çˆ¶å­è¿›ç¨‹çœ‹åˆ°ç›¸åŒçš„ MemPool æ•°é‡
2. âœ… çˆ¶å­è¿›ç¨‹çœ‹åˆ°ç›¸åŒçš„å†…å­˜å¤§å°
3. âœ… RelativePointer åœ¨å¤šè¿›ç¨‹é—´æ­£å¸¸å·¥ä½œ
4. âœ… è¿›ç¨‹æœ¬åœ°å˜é‡ï¼ˆåŸºåœ°å€ï¼‰å¯ä»¥ä¸åŒ

**è¿è¡Œæ–¹å¼**ï¼š
```bash
./build/bin/test_mempool_manager_multiprocess
```

**é¢„æœŸè¾“å‡º**ï¼š
```
======================================================================
MemPoolManager å¤šè¿›ç¨‹å…±äº«å†…å­˜æµ‹è¯•
æµ‹è¯•æ¶æ„ï¼šåŒå…±äº«å†…å­˜ï¼ˆç®¡ç†åŒº + æ•°æ®åŒºï¼‰
æµ‹è¯•é‡ç‚¹ï¼šè¿›ç¨‹æœ¬åœ°å˜é‡ vs ç›¸å¯¹åç§»é‡
======================================================================

[çˆ¶è¿›ç¨‹] PID=12345
[çˆ¶è¿›ç¨‹] åˆ›å»º MemPoolConfigï¼Œ3ä¸ªå†…å­˜æ± 
[çˆ¶è¿›ç¨‹] å…±äº«å®ä¾‹åˆ›å»ºæˆåŠŸ: 0x7f1234567000

[å­è¿›ç¨‹] PID=12346
[å­è¿›ç¨‹] æˆåŠŸé™„åŠ åˆ°å…±äº«å®ä¾‹: 0x7e9876543000
[å­è¿›ç¨‹] MemPool æ•°é‡: 3
[å­è¿›ç¨‹] âœ“ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼

[çˆ¶è¿›ç¨‹] å­è¿›ç¨‹æˆåŠŸé€€å‡º âœ“
[çˆ¶è¿›ç¨‹] âœ“ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼

ğŸ‰ å¤šè¿›ç¨‹æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼
```

## è¿è¡Œæµ‹è¯•

### æ¨èæ–¹å¼ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
cd /home/xinyun/Infrastructure/zero_copy_framework/test/mempool_managertest
./run_test.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
1. âœ… æ¸…ç†æ—§çš„ build ç›®å½•
2. âœ… é…ç½® CMakeï¼ˆC++23ï¼‰
3. âœ… ç¼–è¯‘æ‰€æœ‰æµ‹è¯•ç¨‹åº
4. âœ… è¿è¡Œå•è¿›ç¨‹æµ‹è¯•
5. âœ… è¿è¡Œå¤šè¿›ç¨‹æµ‹è¯•
6. âœ… è¾“å‡ºæ€»ç»“æŠ¥å‘Š

### æ‰‹åŠ¨æ–¹å¼

```bash
# 1. æ„å»º
mkdir -p build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
make -j$(nproc)

# 2. è¿è¡Œæµ‹è¯•
./bin/test_mempool_manager_basic
./bin/test_mempool_manager_multiprocess

# 3. æˆ–ä½¿ç”¨ CTest
ctest --verbose
```

## æµ‹è¯•ç¯å¢ƒè¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Linuxï¼ˆæ”¯æŒ POSIX å…±äº«å†…å­˜ï¼‰
- **ç¼–è¯‘å™¨**: GCC 12+ æˆ– Clang 16+ï¼ˆæ”¯æŒ C++23ï¼‰
- **CMake**: 3.16+

### ä¾èµ–åº“
- `pthread`: POSIX çº¿ç¨‹åº“
- `rt`: POSIX å®æ—¶æ‰©å±•ï¼ˆå…±äº«å†…å­˜ï¼‰

### æƒé™è¦æ±‚
- è¯»å†™ `/dev/shm/` æƒé™ï¼ˆå…±äº«å†…å­˜æŒ‚è½½ç‚¹ï¼‰
- åˆ›å»ºä¿¡å·é‡æƒé™

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ç¼–è¯‘å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
error: 'RelativePointer' does not name a type
```

**åŸå› **ï¼šC++ æ ‡å‡†ä¸è¶³æˆ–å¤´æ–‡ä»¶ç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ç¼–è¯‘å™¨ç‰ˆæœ¬
g++ --version  # åº” >= 12.0

# æ¸…ç†å¹¶é‡æ–°æ„å»º
rm -rf build
./run_test.sh
```

### é—®é¢˜ 2: å…±äº«å†…å­˜åˆ›å»ºå¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Failed to create management shared memory
```

**åŸå› **ï¼š
- æƒé™ä¸è¶³
- å…±äº«å†…å­˜å·²å­˜åœ¨ï¼ˆä¸Šæ¬¡å´©æºƒæœªæ¸…ç†ï¼‰
- ç³»ç»Ÿé™åˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥ç°æœ‰å…±äº«å†…å­˜
ls -lh /dev/shm/ | grep zerocp

# 2. æ¸…ç†
rm -f /dev/shm/zerocp_memory_*
rm -f /dev/shm/zerocp_init_sem

# 3. æ£€æŸ¥ç³»ç»Ÿé™åˆ¶
cat /proc/sys/kernel/shmmax  # æœ€å¤§å…±äº«å†…å­˜æ®µå¤§å°
cat /proc/sys/kernel/shmall  # æ€»å…±äº«å†…å­˜å¤§å°

# 4. å¦‚æœéœ€è¦ï¼Œå¢åŠ é™åˆ¶ï¼ˆéœ€è¦ rootï¼‰
sudo sysctl -w kernel.shmmax=268435456  # 256 MB
sudo sysctl -w kernel.shmall=268435456
```

### é—®é¢˜ 3: å­è¿›ç¨‹æ— æ³•é™„åŠ 

**é”™è¯¯ä¿¡æ¯**ï¼š
```
[å­è¿›ç¨‹] æ— æ³•è·å–å…±äº«å®ä¾‹
```

**åŸå› **ï¼š
- çˆ¶è¿›ç¨‹æœªå®Œæˆåˆå§‹åŒ–
- ä¿¡å·é‡é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤çˆ¶è¿›ç¨‹æˆåŠŸåˆ›å»ºå®ä¾‹
- æ£€æŸ¥ä¿¡å·é‡æ˜¯å¦æ­£å¸¸ï¼š`ls -l /dev/shm/zerocp_init_sem`
- å¢åŠ å­è¿›ç¨‹çš„ç­‰å¾…æ—¶é—´ï¼ˆåœ¨ `childProcess` ä¸­çš„ `sleep(1)`ï¼‰

### é—®é¢˜ 4: å†…å­˜å¤§å°è®¡ç®—é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Assertion failed: totalSize == mgmtSize + chunkSize
```

**åŸå› **ï¼šå†…å­˜å¤§å°è®¡ç®—é€»è¾‘é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ `getManagementMemorySize()` å®ç°
- æ£€æŸ¥ `getChunkMemorySize()` å®ç°
- ç¡®ä¿æ²¡æœ‰å†…å­˜å¯¹é½é—®é¢˜

## æµ‹è¯•è¦†ç›–ç‡

### å•è¿›ç¨‹æµ‹è¯•è¦†ç›–

- âœ… é…ç½®ç®¡ç† (`MemPoolConfig`)
- âœ… å®ä¾‹åˆ›å»º (`createSharedInstance`)
- âœ… å®ä¾‹è·å– (`getInstanceIfInitialized`)
- âœ… å†…å­˜è®¡ç®— (`getManagementMemorySize`, `getChunkMemorySize`, `getTotalMemorySize`)
- âœ… MemPool è®¿é—® (`getMemPools`)
- âœ… ChunkManager è®¿é—® (`getChunkManagerPool`)
- âœ… ç»Ÿè®¡ä¿¡æ¯ (`printAllPoolStats`)
- âœ… å®ä¾‹é”€æ¯ (`destroySharedInstance`)

### å¤šè¿›ç¨‹æµ‹è¯•è¦†ç›–

- âœ… è·¨è¿›ç¨‹å…±äº«å†…å­˜è®¿é—®
- âœ… çˆ¶è¿›ç¨‹åˆ›å»º + å­è¿›ç¨‹é™„åŠ 
- âœ… RelativePointer å¤šè¿›ç¨‹ä¸€è‡´æ€§
- âœ… è¿›ç¨‹æœ¬åœ°å˜é‡ç‹¬ç«‹æ€§
- âœ… ä¿¡å·é‡åŒæ­¥

### æœªè¦†ç›–ï¼ˆéœ€è¦é¢å¤–æµ‹è¯•ï¼‰

- âš ï¸ å†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼ˆ`allocate`, `deallocate`ï¼‰
- âš ï¸ å¹¶å‘åˆ†é…ï¼ˆå¤šçº¿ç¨‹ï¼‰
- âš ï¸ å‹åŠ›æµ‹è¯•ï¼ˆå¤§é‡åˆ†é…ï¼‰
- âš ï¸ é”™è¯¯æ¢å¤ï¼ˆå¼‚å¸¸å¤„ç†ï¼‰

## æ‰©å±•æµ‹è¯•å»ºè®®

### 1. æ€§èƒ½æµ‹è¯•

```cpp
// æµ‹è¯•åˆ†é…æ€§èƒ½
auto start = std::chrono::high_resolution_clock::now();
for (int i = 0; i < 10000; ++i) {
    void* ptr = allocate(1024);
    deallocate(ptr);
}
auto end = std::chrono::high_resolution_clock::now();
auto duration = std::chrono::duration_cast<std::chrono::microseconds>(end - start);
```

### 2. å¹¶å‘æµ‹è¯•

```cpp
// å¤šçº¿ç¨‹åˆ†é…æµ‹è¯•
std::vector<std::thread> threads;
for (int i = 0; i < 10; ++i) {
    threads.emplace_back([]() {
        for (int j = 0; j < 1000; ++j) {
            void* ptr = allocate(256);
            deallocate(ptr);
        }
    });
}
for (auto& t : threads) t.join();
```

### 3. å‹åŠ›æµ‹è¯•

```cpp
// åˆ†é…æ‰€æœ‰å¯ç”¨å†…å­˜
std::vector<void*> ptrs;
while (true) {
    void* ptr = allocate(1024);
    if (ptr == nullptr) break;
    ptrs.push_back(ptr);
}
// éªŒè¯åˆ†é…æ•°é‡
// é‡Šæ”¾æ‰€æœ‰å†…å­˜
for (void* ptr : ptrs) {
    deallocate(ptr);
}
```

## ç›¸å…³æ–‡æ¡£

- [README.md](./README.md) - æµ‹è¯•å¥—ä»¶æ¦‚è¿°
- [å…±äº«å†…å­˜åŸºåœ°å€è®¾è®¡](../../docs/Shared_Memory_Base_Address_Design.md)
- [MemPoolManager å¤´æ–‡ä»¶](../../zerocp_daemon/memory/include/mempool_manager.hpp)

## ç»´æŠ¤è¯´æ˜

### æ·»åŠ æ–°æµ‹è¯•

1. ç¡®å®šæµ‹è¯•ç±»å‹ï¼ˆå•è¿›ç¨‹ vs å¤šè¿›ç¨‹ï¼‰
2. åœ¨å¯¹åº”æ–‡ä»¶ä¸­æ·»åŠ æµ‹è¯•å‡½æ•°
3. åœ¨ `main()` ä¸­è°ƒç”¨æ–°æµ‹è¯•
4. æ›´æ–°æœ¬æ–‡æ¡£

### ä¿®æ”¹æµ‹è¯•

1. ç¡®ä¿ä¸ç ´åç°æœ‰æµ‹è¯•
2. æ›´æ–°ç›¸å…³æ³¨é‡Š
3. é‡æ–°è¿è¡Œæ‰€æœ‰æµ‹è¯•éªŒè¯

### æµ‹è¯•å‘½åè§„èŒƒ

- å•è¿›ç¨‹æµ‹è¯•ï¼š`test_<feature_name>()`
- å¤šè¿›ç¨‹æµ‹è¯•ï¼š`parentProcess()`, `childProcess()`
- è¾…åŠ©å‡½æ•°ï¼š`<verb><Noun>()`

---

**æœ€åæ›´æ–°**: 2025-10-30  
**ç»´æŠ¤è€…**: ZeroCopy Framework Team


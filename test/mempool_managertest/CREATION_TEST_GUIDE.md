# MemPoolManager åˆ›å»ºéªŒè¯æµ‹è¯•æŒ‡å—

## æµ‹è¯•ç›®çš„

`test_mempool_creation` æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºéªŒè¯ MemPoolManager æ˜¯å¦èƒ½å¤ŸæˆåŠŸåˆ›å»ºå’Œæ­£ç¡®åˆå§‹åŒ–çš„æµ‹è¯•ç¨‹åºã€‚

## æµ‹è¯•è¦†ç›–èŒƒå›´

### âœ… æµ‹è¯•é¡¹ç›®

1. **é…ç½®åˆ›å»ºéªŒè¯**
   - åˆ›å»º MemPoolConfig
   - æ·»åŠ å¤šä¸ªå†…å­˜æ± é…ç½®
   - éªŒè¯é…ç½®å‚æ•°

2. **å…±äº«å®ä¾‹åˆ›å»ºéªŒè¯**
   - åˆ›å»ºå…±äº«å†…å­˜æ®µï¼ˆç®¡ç†åŒº + æ•°æ®åŒºï¼‰
   - åœ¨å…±äº«å†…å­˜ä¸­æ„é€  MemPoolManager
   - éªŒè¯å®ä¾‹å¯ä»¥æ­£ç¡®è·å–

3. **å†…å­˜å¸ƒå±€éªŒè¯**
   - éªŒè¯ç®¡ç†åŒºå†…å­˜å¤§å°è®¡ç®—
   - éªŒè¯æ•°æ®åŒºå†…å­˜å¤§å°è®¡ç®—
   - éªŒè¯æ€»å†…å­˜å¤§å°

4. **MemPool é…ç½®éªŒè¯**
   - éªŒè¯æ¯ä¸ªæ± çš„é…ç½®å‚æ•°
   - éªŒè¯åˆå§‹ç©ºé—²æ•°é‡
   - éªŒè¯ dataOffset è®¾ç½®
   - éªŒè¯æ± çš„åˆå§‹çŠ¶æ€

5. **ChunkManagerPool éªŒè¯**
   - éªŒè¯ ChunkManagerPool åˆ›å»º
   - éªŒè¯ ChunkManager æ•°é‡
   - éªŒè¯åˆå§‹çŠ¶æ€

6. **ç»Ÿè®¡ä¿¡æ¯è¾“å‡º**
   - æ‰“å°æ‰€æœ‰æ± çš„çŠ¶æ€
   - æ˜¾ç¤ºå†…å­˜ä½¿ç”¨æƒ…å†µ

7. **æ¸…ç†å’Œé”€æ¯éªŒè¯**
   - é”€æ¯å…±äº«å®ä¾‹
   - éªŒè¯å®ä¾‹è¢«æ­£ç¡®é”€æ¯
   - æ¸…ç†å…±äº«å†…å­˜èµ„æº

## å¿«é€Ÿè¿è¡Œ

### ä½¿ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd test/mempool_managertest
./run_creation_test.sh
```

### æ‰‹åŠ¨è¿è¡Œ

```bash
# 1. æ¸…ç†æ—§çš„å…±äº«å†…å­˜
rm -f /dev/shm/zerocp_memory_management
rm -f /dev/shm/zerocp_memory_chunk
rm -f /dev/shm/sem.zerocp_init_sem

# 2. ç¼–è¯‘
cd test/mempool_managertest
mkdir -p build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
make test_mempool_creation -j$(nproc)

# 3. è¿è¡Œæµ‹è¯•
./bin/test_mempool_creation

# 4. æ¸…ç†ï¼ˆæµ‹è¯•åï¼‰
rm -f /dev/shm/zerocp_memory_management
rm -f /dev/shm/zerocp_memory_chunk
rm -f /dev/shm/sem.zerocp_init_sem
```

## æµ‹è¯•è¾“å‡ºè¯´æ˜

### æˆåŠŸè¾“å‡ºç¤ºä¾‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                   â•‘
â•‘        MemPoolManager åˆ›å»ºéªŒè¯æµ‹è¯•                                â•‘
â•‘        ZeroCP Framework Test Suite                               â•‘
â•‘                                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â„¹ æµ‹è¯•ç›®æ ‡ï¼šéªŒè¯ MemPoolManager æ˜¯å¦èƒ½å¤ŸæˆåŠŸåˆ›å»ºå¹¶æ­£ç¡®åˆå§‹åŒ–
â„¹ è¿›ç¨‹ ID: 12345

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯• 1: åˆ›å»º MemPoolConfig
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ MemPoolConfig åˆ›å»ºæˆåŠŸ
  é…ç½®çš„å†…å­˜æ± æ•°é‡: 3
  Pool[0]: chunkSize=128B, count=100, total=12 KB
  Pool[1]: chunkSize=1024B, count=50, total=50 KB
  Pool[2]: chunkSize=4096B, count=20, total=80 KB

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯• 2: åˆ›å»ºå…±äº«å®ä¾‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â„¹ å·²æ¸…ç†æ—§å®ä¾‹
âœ“ å…±äº«å®ä¾‹åˆ›å»ºæˆåŠŸ
âœ“ å®ä¾‹è·å–æˆåŠŸ
  å®ä¾‹åœ°å€: 0x7f8000000000

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯• 3: éªŒè¯å†…å­˜å¸ƒå±€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ å†…å­˜å¤§å°è®¡ç®—æ­£ç¡®
  ç®¡ç†åŒºå¤§å°: 11 KB (11484 bytes)
  æ•°æ®åŒºå¤§å°: 150 KB (154080 bytes)
  æ€»å¤§å°:     165 KB (165564 bytes)
âœ“ å†…å­˜å¸ƒå±€éªŒè¯é€šè¿‡

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯• 4: éªŒè¯ MemPool é…ç½®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ è·å– MemPool åˆ—è¡¨æˆåŠŸ
  MemPool æ•°é‡: 3

  Pool[0] è¯¦ç»†ä¿¡æ¯:
    - Chunk å¤§å°: 128 B
    - Chunk æ•°é‡: 100
    - ç©ºé—² Chunks: 100
    - å·²ç”¨ Chunks: 0
    - dataOffset: 0

  Pool[1] è¯¦ç»†ä¿¡æ¯:
    - Chunk å¤§å°: 1024 B
    - Chunk æ•°é‡: 50
    - ç©ºé—² Chunks: 50
    - å·²ç”¨ Chunks: 0
    - dataOffset: 17600

  Pool[2] è¯¦ç»†ä¿¡æ¯:
    - Chunk å¤§å°: 4096 B
    - Chunk æ•°é‡: 20
    - ç©ºé—² Chunks: 20
    - å·²ç”¨ Chunks: 0
    - dataOffset: 71200

âœ“ æ‰€æœ‰ MemPool é…ç½®éªŒè¯é€šè¿‡

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯• 5: éªŒè¯ ChunkManagerPool
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ è·å– ChunkManagerPool æˆåŠŸ
  ChunkManagerPool æ•°é‡: 1

  ChunkManagerPool[0] è¯¦ç»†ä¿¡æ¯:
    - ChunkManager å¤§å°: 56 B
    - ChunkManager æ•°é‡: 170
    - ç©ºé—²æ•°é‡: 170
    - å·²ç”¨æ•°é‡: 0

âœ“ ChunkManagerPool éªŒè¯é€šè¿‡

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯• 6: æ‰“å°ç»Ÿè®¡ä¿¡æ¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[MemPool ç»Ÿè®¡ä¿¡æ¯]
Pool[0]: 128B chunks, 100/100 free (0% used)
Pool[1]: 1024B chunks, 50/50 free (0% used)
Pool[2]: 4096B chunks, 20/20 free (0% used)

âœ“ ç»Ÿè®¡ä¿¡æ¯æ‰“å°æˆåŠŸ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯• 7: æ¸…ç†å’Œé”€æ¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ å…±äº«å®ä¾‹é”€æ¯æˆåŠŸ
âœ“ å®ä¾‹é”€æ¯éªŒè¯é€šè¿‡

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æµ‹è¯•ç»“æœæ±‡æ€»
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  æ€»æµ‹è¯•æ•°: 7
  é€šè¿‡æ•°é‡: 7
  å¤±è´¥æ•°é‡: 0
  é€šè¿‡ç‡:   100.0%

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼MemPoolManager åˆ›å»ºæˆåŠŸï¼

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### æµ‹è¯•å¤±è´¥æƒ…å†µ

å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
âœ— å…±äº«å®ä¾‹åˆ›å»ºå¤±è´¥

æµ‹è¯•ç»“æœæ±‡æ€»

  æ€»æµ‹è¯•æ•°: 7
  é€šè¿‡æ•°é‡: 1
  å¤±è´¥æ•°é‡: 6
  é€šè¿‡ç‡:   14.3%

âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. å…±äº«å†…å­˜åˆ›å»ºå¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
âœ— å…±äº«å®ä¾‹åˆ›å»ºå¤±è´¥
Failed to create management shared memory
```

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥å…±äº«å†…å­˜æƒé™
ls -la /dev/shm/

# æ¸…ç†æ—§çš„å…±äº«å†…å­˜
rm -f /dev/shm/zerocp_memory_*
rm -f /dev/shm/sem.zerocp_init_sem

# æ£€æŸ¥å¯ç”¨ç©ºé—´
df -h /dev/shm
```

#### 2. æƒé™ä¸è¶³

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Permission denied
```

**è§£å†³æ–¹æ³•**ï¼š
```bash
# ç¡®ä¿æœ‰è¯»å†™æƒé™
chmod 666 /dev/shm/zerocp_memory_*

# æˆ–ä»¥åˆé€‚çš„ç”¨æˆ·è¿è¡Œæµ‹è¯•
```

#### 3. å†…å­˜ä¸è¶³

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Failed to allocate memory
```

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥å¯ç”¨å†…å­˜
free -h

# å¢åŠ  /dev/shm å¤§å°ï¼ˆéœ€è¦ rootï¼‰
sudo mount -o remount,size=2G /dev/shm
```

#### 4. ç¼–è¯‘é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ¸…ç† build ç›®å½•
rm -rf build

# é‡æ–°ç¼–è¯‘
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
make clean
make test_mempool_creation -j$(nproc)
```

## æµ‹è¯•é…ç½®

### é»˜è®¤é…ç½®

- **Pool 0**: 128B Ã— 100 chunks = 12.8 KB
- **Pool 1**: 1024B Ã— 50 chunks = 50 KB
- **Pool 2**: 4096B Ã— 20 chunks = 80 KB
- **æ€»æ•°æ®åŒº**: ~150 KB
- **æ€»ç®¡ç†åŒº**: ~11 KB
- **æ€»å†…å­˜**: ~165 KB

### ä¿®æ”¹é…ç½®

åœ¨ `test_mempool_creation.cpp` çš„ `test_01_CreateConfig` å‡½æ•°ä¸­ä¿®æ”¹ï¼š

```cpp
bool r1 = config.addMemPoolEntry(128, 100);   // ä¿®æ”¹è¿™é‡Œ
bool r2 = config.addMemPoolEntry(1024, 50);   // ä¿®æ”¹è¿™é‡Œ
bool r3 = config.addMemPoolEntry(4096, 20);   // ä¿®æ”¹è¿™é‡Œ
```

## ä¸å…¶ä»–æµ‹è¯•çš„å…³ç³»

1. **test_mempool_creation.cpp** â­ 
   - æœ€ç®€å•çš„æµ‹è¯•
   - åªéªŒè¯åˆ›å»ºå’Œåˆå§‹åŒ–
   - æ¨èç¬¬ä¸€ä¸ªè¿è¡Œ

2. **test_mempool_manager_basic.cpp**
   - æ›´è¯¦ç»†çš„å•è¿›ç¨‹æµ‹è¯•
   - åŒ…å«æ›´å¤šåŠŸèƒ½æµ‹è¯•
   - åŸºäºåˆ›å»ºæµ‹è¯•çš„åŸºç¡€ä¸Šæ·»åŠ æ›´å¤šéªŒè¯

3. **test_mempool_manager_multiprocess.cpp**
   - å¤šè¿›ç¨‹æµ‹è¯•
   - éªŒè¯è·¨è¿›ç¨‹å…±äº«
   - æœ€å¤æ‚çš„æµ‹è¯•åœºæ™¯

## é›†æˆåˆ° CI/CD

### GitLab CI ç¤ºä¾‹

```yaml
test:mempool_creation:
  stage: test
  script:
    - cd test/mempool_managertest
    - ./run_creation_test.sh
  artifacts:
    when: always
    reports:
      junit: build/test_results.xml
```

### GitHub Actions ç¤ºä¾‹

```yaml
- name: Run MemPoolManager Creation Test
  run: |
    cd test/mempool_managertest
    ./run_creation_test.sh
```

## æ€§èƒ½åŸºå‡†

åœ¨å…¸å‹çš„å¼€å‘ç¯å¢ƒä¸­ï¼ˆIntel i7, 16GB RAMï¼‰ï¼š

- **ç¼–è¯‘æ—¶é—´**: ~5-10 ç§’
- **è¿è¡Œæ—¶é—´**: < 1 ç§’
- **å†…å­˜å ç”¨**: ~200 KBï¼ˆå…±äº«å†…å­˜ï¼‰
- **CPU å ç”¨**: æœ€å°

## ç›¸å…³æ–‡æ¡£

- [README.md](README.md) - å®Œæ•´æµ‹è¯•å¥—ä»¶è¯´æ˜
- [shared_memory_layout_detailed.md](../../zerocp_daemon/memory/shared_memory_layout_detailed.md) - è¯¦ç»†å†…å­˜å¸ƒå±€
- [TEST_GUIDE.md](TEST_GUIDE.md) - æµ‹è¯•æŒ‡å—
- [QUICKSTART.md](QUICKSTART.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—

## æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æµ‹è¯•è¾“å‡ºæ—¥å¿—
2. æ£€æŸ¥å…±äº«å†…å­˜çŠ¶æ€
3. å‚è€ƒæ•…éšœæ’æŸ¥éƒ¨åˆ†
4. æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“


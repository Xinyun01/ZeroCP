# Quick Start - MemPoolManager 测试

## 5 秒快速开始

```bash
cd /home/xinyun/Infrastructure/zero_copy_framework/test/mempool_managertest
./run_test.sh
```

就这么简单！脚本会自动完成所有事情。✨

## 测试内容

### ✅ 单进程基础测试
- MemPoolConfig 创建
- 共享实例创建和销毁
- 双共享内存架构（管理区 + 数据区）
- MemPool 访问和验证

### ✅ 多进程共享内存测试
- 父进程创建共享实例
- 子进程附加到已有实例
- 验证 RelativePointer 在多进程间工作
- 验证进程本地变量独立性

## 预期输出

```
================================================
  MemPoolManager 测试套件
  测试双共享内存架构（管理区 + 数据区）
================================================

[步骤 1/4] 配置 CMake...
✓ CMake 配置完成

[步骤 2/4] 编译测试程序...
✓ 编译成功

[步骤 3/4] 运行测试...

──────────────────────────────────────────────
测试 1: 基础单进程测试
──────────────────────────────────────────────
======================================================================
MemPoolManager 基础单进程测试
测试双共享内存架构（管理区 + 数据区）
======================================================================

[TEST 1] MemPoolConfig 创建和配置
✓ PASS - MemPoolConfig 创建和配置 (3个内存池配置成功)

[TEST 2] 共享实例创建
✓ PASS - 共享实例创建 (实例创建并获取成功)

[TEST 3] 内存大小计算（管理区 + 数据区）
✓ PASS - 内存大小计算 (Total=162 KB)

[TEST 4] MemPool 访问和验证
✓ PASS - MemPool 访问和验证 (3 个 MemPool 验证通过)

[TEST 5] 共享内存基地址验证
✓ PASS - 共享内存基地址验证 (双共享内存架构正确)

[TEST 6] 统计信息打印
✓ PASS - 统计信息打印 (统计信息输出成功)

[TEST 7] 共享实例销毁
✓ PASS - 共享实例销毁 (实例清理成功)

======================================================================
测试总结
======================================================================
总计: 7 个测试
通过: 7 ✓
失败: 0 ✗
======================================================================
🎉 所有测试通过！

──────────────────────────────────────────────
测试 2: 多进程共享内存测试
──────────────────────────────────────────────
======================================================================
MemPoolManager 多进程共享内存测试
测试架构：双共享内存（管理区 + 数据区）
测试重点：进程本地变量 vs 相对偏移量
======================================================================

[父进程] PID=12345
[父进程] 创建 MemPoolConfig，3个内存池
[父进程] 共享实例创建成功: 0x7f1234567000
[父进程] ✓ 初始化完成，等待子进程...

[子进程] PID=12346
[子进程] 成功附加到共享实例: 0x7e9876543000
[子进程] MemPool 数量: 3
[子进程] ✓ 所有验证通过！

[父进程] 子进程成功退出 ✓
[父进程] ✓ 所有验证通过！

======================================================================
🎉 多进程测试全部通过！
======================================================================

[步骤 4/4] 测试总结
================================================
✓ 测试 1 (基础单进程): 通过
✓ 测试 2 (多进程共享内存): 通过
================================================
🎉 所有测试通过！
```

## 如果测试失败

### 1. 清理共享内存

```bash
rm -f /dev/shm/zerocp_memory_*
rm -f /dev/shm/zerocp_init_sem
```

### 2. 重新运行

```bash
./run_test.sh
```

### 3. 查看详细日志

测试程序会输出详细的日志信息，包括：
- 每个测试步骤的状态
- 内存地址信息
- MemPool 配置详情
- 错误信息（如果有）

## 手动运行单个测试

```bash
# 构建
mkdir -p build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
make -j$(nproc)

# 运行单进程测试
./bin/test_mempool_manager_basic

# 运行多进程测试
./bin/test_mempool_manager_multiprocess
```

## 核心验证点

本测试验证了 MemPoolManager 的核心设计：

### 🎯 双共享内存架构

```
管理区 (/zerocp_memory_management)
  ↓
  s_managementBaseAddress (进程本地)
  
数据区 (/zerocp_memory_chunk)
  ↓
  s_chunkBaseAddress (进程本地)
```

### 🎯 进程本地 vs 共享内存

- **进程本地变量**：基地址（每个进程可能不同）
- **共享内存数据**：RelativePointer（所有进程相同）

### 🎯 多进程一致性

- 父子进程看到相同的 MemPool 配置 ✓
- RelativePointer 在不同进程中正确解析 ✓
- 内存大小计算一致 ✓

## 下一步

- 📖 详细文档：[README.md](./README.md)
- 📖 测试指南：[TEST_GUIDE.md](./TEST_GUIDE.md)
- 📖 设计说明：[../../docs/Shared_Memory_Base_Address_Design.md](../../docs/Shared_Memory_Base_Address_Design.md)

## 问题反馈

如果遇到问题：
1. 检查 `/dev/shm/` 权限
2. 确认编译器版本（GCC 12+ 或 Clang 16+）
3. 查看系统共享内存限制（`/proc/sys/kernel/shm*`）
4. 查阅 [TEST_GUIDE.md](./TEST_GUIDE.md) 的故障排查部分

---

Happy Testing! 🚀

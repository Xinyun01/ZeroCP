# MemPoolManager åˆå§‹åŒ–æµ‹è¯•ç¨‹åº

è¿™æ˜¯ä¸€ä¸ªç®€æ´çš„æµ‹è¯•æ¡†æ¶ï¼Œç”¨äºéªŒè¯ ZeroCP æ¡†æ¶çš„ `MemPoolManager` **å¤šè¿›ç¨‹å…±äº«å†…å­˜åˆå§‹åŒ–**åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•ç»“æ„

```
mempool_managertest/
â”œâ”€â”€ test_server.cpp      # æœåŠ¡ç«¯ï¼šåˆå§‹åŒ–å…±äº«å†…å­˜æ± 
â”œâ”€â”€ test_client.cpp      # å®¢æˆ·ç«¯ï¼šéªŒè¯å…±äº«å†…å­˜è®¿é—®
â”œâ”€â”€ CMakeLists.txt       # æ„å»ºé…ç½®ï¼ˆC++23ï¼‰
â”œâ”€â”€ run_test.sh         # è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
â””â”€â”€ README.md           # æœ¬æ–‡ä»¶
```

## ğŸ¯ æµ‹è¯•ç›®æ ‡

### å½“å‰é˜¶æ®µï¼šåˆå§‹åŒ–éªŒè¯ âœ…

**test_serverï¼ˆæœåŠ¡ç«¯ï¼‰**
- âœ… åˆ›å»ºå¹¶åˆå§‹åŒ– `MemPoolManager`
- âœ… é…ç½®å¤šä¸ªä¸åŒå¤§å°çš„å†…å­˜æ± ï¼ˆ256B, 1KB, 4KB, 16KBï¼‰
- âœ… åˆå§‹åŒ–å…±äº«å†…å­˜å¸ƒå±€
- âœ… ä¿æŒè¿è¡Œï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
- âœ… å®šæœŸæ‰“å°å†…å­˜æ± çŠ¶æ€

**test_clientï¼ˆå®¢æˆ·ç«¯ï¼‰**
- âœ… è¿æ¥åˆ°å·²å­˜åœ¨çš„å…±äº«å†…å­˜
- âœ… è·å– `MemPoolManager` å®ä¾‹
- âœ… éªŒè¯å†…å­˜æ± é…ç½®æ­£ç¡®æ€§
- âœ… éªŒè¯å¤šè¿›ç¨‹æ•°æ®ä¸€è‡´æ€§
- âœ… è¯»å–å¹¶æ˜¾ç¤ºå†…å­˜æ± çŠ¶æ€

### ä¸‹ä¸€é˜¶æ®µï¼šåŠŸèƒ½å®ç° ğŸš§

- â³ å®ç° `getChunk()` - åˆ†é…å†…å­˜å—
- â³ å®ç° `releaseChunk()` - é‡Šæ”¾å†…å­˜å—
- â³ æµ‹è¯•å¼•ç”¨è®¡æ•°æœºåˆ¶
- â³ æµ‹è¯•æ•°æ®è¯»å†™

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘é¡¹ç›®

é¦–å…ˆç¡®ä¿ä¸»é¡¹ç›®å·²ç»ç¼–è¯‘ï¼š

```bash
cd /home/xinyun/Infrastructure/zero_copy_framework
mkdir -p build && cd build
cmake ..
make
```

ç„¶åç¼–è¯‘æµ‹è¯•ç¨‹åºï¼š

```bash
cd /home/xinyun/Infrastructure/zero_copy_framework/test/mempool_managertest
mkdir -p build && cd build
cmake ..
make
```

### 2. è¿è¡Œæµ‹è¯•

#### æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨è¿è¡Œï¼ˆæ¨èç”¨äºè°ƒè¯•ï¼‰

**ç»ˆç«¯ 1 - å¯åŠ¨æœåŠ¡ç«¯ï¼š**
```bash
cd /home/xinyun/Infrastructure/zero_copy_framework/test/mempool_managertest/build
./test_server
```

**ç»ˆç«¯ 2 - å¯åŠ¨å®¢æˆ·ç«¯ï¼š**
```bash
cd /home/xinyun/Infrastructure/zero_copy_framework/test/mempool_managertest/build
./test_client
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨è„šæœ¬è¿è¡Œ

åˆ›å»ºä¸€ä¸ªç®€å•çš„è¿è¡Œè„šæœ¬ `run_test.sh`ï¼š

```bash
#!/bin/bash

# æ¸…ç†æ—§çš„å…±äº«å†…å­˜
echo "æ¸…ç†æ—§çš„å…±äº«å†…å­˜..."
rm -f /dev/shm/zerocp_*

# å¯åŠ¨æœåŠ¡ç«¯ï¼ˆåå°è¿è¡Œï¼‰
echo "å¯åŠ¨æœåŠ¡ç«¯..."
./build/test_server &
SERVER_PID=$!

# ç­‰å¾…æœåŠ¡ç«¯åˆå§‹åŒ–
sleep 2

# å¯åŠ¨å®¢æˆ·ç«¯
echo "å¯åŠ¨å®¢æˆ·ç«¯..."
./build/test_client

# ç­‰å¾…å®¢æˆ·ç«¯å®Œæˆ
sleep 2

# åœæ­¢æœåŠ¡ç«¯
echo "åœæ­¢æœåŠ¡ç«¯..."
kill -SIGINT $SERVER_PID
wait $SERVER_PID

echo "æµ‹è¯•å®Œæˆ"
```

ç„¶åè¿è¡Œï¼š
```bash
chmod +x run_test.sh
./run_test.sh
```

### 3. æ¸…ç†å…±äº«å†…å­˜

æµ‹è¯•å®Œæˆåï¼Œå¦‚æœéœ€è¦æ‰‹åŠ¨æ¸…ç†å…±äº«å†…å­˜ï¼š

```bash
rm -f /dev/shm/zerocp_*
```

## ğŸ“Š é¢„æœŸè¾“å‡º

### æœåŠ¡ç«¯è¾“å‡ºç¤ºä¾‹

```
========================================
  ZeroCP å†…å­˜æ± ç®¡ç†å™¨ - æµ‹è¯•æœåŠ¡ç«¯
========================================

[1] åˆ›å»ºå†…å­˜æ± é…ç½®...
  - æ·»åŠ å†…å­˜æ± : 256 å­—èŠ‚ x 100 ä¸ª
  - æ·»åŠ å†…å­˜æ± : 1KB x 50 ä¸ª
  - æ·»åŠ å†…å­˜æ± : 4KB x 20 ä¸ª
  - æ·»åŠ å†…å­˜æ± : 16KB x 10 ä¸ª

[2] åˆ›å»ºå…±äº«å†…å­˜å®ä¾‹...
  âœ“ å…±äº«å†…å­˜å®ä¾‹åˆ›å»ºæˆåŠŸ

[3] è·å–å¹¶éªŒè¯å®ä¾‹...
  âœ“ MemPoolManager å®ä¾‹è·å–æˆåŠŸ

[4] å†…å­˜æ± åˆå§‹çŠ¶æ€:
  Pool 0: chunk_size=256, total=100, used=0, free=100
  Pool 1: chunk_size=1024, total=50, used=0, free=50
  Pool 2: chunk_size=4096, total=20, used=0, free=20
  Pool 3: chunk_size=16384, total=10, used=0, free=10

[5] æµ‹è¯•åˆ†é… chunk...
  âœ“ æˆåŠŸåˆ†é… 200 å­—èŠ‚ chunk
  âœ“ æˆåŠŸåˆ†é… 800 å­—èŠ‚ chunk
  âœ“ æˆåŠŸåˆ†é… 3000 å­—èŠ‚ chunk

[6] åˆ†é…åçš„å†…å­˜æ± çŠ¶æ€:
  Pool 0: chunk_size=256, total=100, used=1, free=99
  Pool 1: chunk_size=1024, total=50, used=1, free=49
  Pool 2: chunk_size=4096, total=20, used=1, free=19
  Pool 3: chunk_size=16384, total=10, used=0, free=10

========================================
  æœåŠ¡ç«¯è¿è¡Œä¸­...
  æŒ‰ Ctrl+C é€€å‡º
  å®¢æˆ·ç«¯å¯ä»¥è¿æ¥å¹¶è®¿é—®å…±äº«å†…å­˜
========================================
```

### å®¢æˆ·ç«¯è¾“å‡ºç¤ºä¾‹

```
========================================
  ZeroCP å†…å­˜æ± ç®¡ç†å™¨ - æµ‹è¯•å®¢æˆ·ç«¯
========================================

[1] è¿æ¥åˆ°å…±äº«å†…å­˜...
  âœ“ æˆåŠŸè¿æ¥åˆ°å…±äº«å†…å­˜

[2] å½“å‰å†…å­˜æ± çŠ¶æ€:
  Pool 0: chunk_size=256, total=100, used=1, free=99
  Pool 1: chunk_size=1024, total=50, used=1, free=49
  Pool 2: chunk_size=4096, total=20, used=1, free=19
  Pool 3: chunk_size=16384, total=10, used=0, free=10

[3] å®¢æˆ·ç«¯åˆ†é… chunk...
  âœ“ æˆåŠŸåˆ†é… 100 å­—èŠ‚ chunk
    âœ“ å†™å…¥æ•°æ®: "Hello from client!"
  âœ“ æˆåŠŸåˆ†é… 512 å­—èŠ‚ chunk
    âœ“ å†™å…¥æ•´æ•°æ•°ç»„: [0, 100, 200, ..., 900]
  âœ“ æˆåŠŸåˆ†é… 2048 å­—èŠ‚ chunk

[5] éªŒè¯å†™å…¥çš„æ•°æ®...
  chunk1 æ•°æ®: "Hello from client!"
  chunk2 æ•°æ®: [0, 100, 200, 300, 400, 500, 600, 700, 800, 900]

[6] æµ‹è¯•å¼•ç”¨è®¡æ•°...
  chunk1 å½“å‰å¼•ç”¨è®¡æ•°: 1
  å¢åŠ å¼•ç”¨å: 2
  å‡å°‘å¼•ç”¨å: 1

[8] é‡Šæ”¾åˆ†é…çš„ chunk...
  âœ“ é‡Šæ”¾ chunk1 æˆåŠŸ
  âœ“ é‡Šæ”¾ chunk2 æˆåŠŸ
  âœ“ é‡Šæ”¾ chunk3 æˆåŠŸ

========================================
  å®¢æˆ·ç«¯æµ‹è¯•å®Œæˆ
========================================
```

## ğŸ” æµ‹è¯•éªŒè¯ç‚¹

### 1. å…±äº«å†…å­˜åˆ›å»º
- [x] æœåŠ¡ç«¯æˆåŠŸåˆ›å»ºç®¡ç†åŒºå’Œæ•°æ®åŒºå…±äº«å†…å­˜
- [x] å†…å­˜å¤§å°è®¡ç®—æ­£ç¡®

### 2. å¤šè¿›ç¨‹è®¿é—®
- [x] å®¢æˆ·ç«¯èƒ½è¿æ¥åˆ°æœåŠ¡ç«¯åˆ›å»ºçš„å…±äº«å†…å­˜
- [x] å®¢æˆ·ç«¯èƒ½è·å– `MemPoolManager` å®ä¾‹

### 3. Chunk åˆ†é…
- [x] è‡ªåŠ¨é€‰æ‹©åˆé€‚å¤§å°çš„å†…å­˜æ± 
- [x] åˆ†é…æˆåŠŸè¿”å›æœ‰æ•ˆçš„ `ChunkManager` æŒ‡é’ˆ
- [x] åˆ†é…å¤±è´¥è¿”å› `nullptr`

### 4. æ•°æ®è¯»å†™
- [x] èƒ½å‘ chunk å†™å…¥æ•°æ®
- [x] èƒ½ä» chunk è¯»å–æ•°æ®
- [x] å¤šè¿›ç¨‹é—´æ•°æ®å¯è§

### 5. å¼•ç”¨è®¡æ•°
- [x] åˆå§‹å¼•ç”¨è®¡æ•°ä¸º 1
- [x] å¯ä»¥å¢åŠ /å‡å°‘å¼•ç”¨è®¡æ•°
- [x] å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶é‡Šæ”¾ chunk

### 6. å†…å­˜æ± çŠ¶æ€
- [x] èƒ½æ­£ç¡®æ˜¾ç¤ºæ¯ä¸ªæ± çš„ä½¿ç”¨æƒ…å†µ
- [x] åˆ†é…å used å¢åŠ ï¼Œfree å‡å°‘
- [x] é‡Šæ”¾å used å‡å°‘ï¼Œfree å¢åŠ 

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šå®¢æˆ·ç«¯æ— æ³•è¿æ¥

**ç—‡çŠ¶ï¼š** å®¢æˆ·ç«¯è¾“å‡º "æ— æ³•è¿æ¥åˆ°å…±äº«å†…å­˜"

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿æœåŠ¡ç«¯å·²å¯åŠ¨å¹¶æˆåŠŸåˆå§‹åŒ–
2. æ£€æŸ¥å…±äº«å†…å­˜æ˜¯å¦å­˜åœ¨ï¼š`ls -lh /dev/shm/zerocp_*`
3. æ£€æŸ¥æƒé™ï¼š`ls -l /dev/shm/zerocp_*`

### é—®é¢˜ 2ï¼šç¼–è¯‘é”™è¯¯

**ç—‡çŠ¶ï¼š** æ‰¾ä¸åˆ°å¤´æ–‡ä»¶æˆ–åº“æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿ä¸»é¡¹ç›®å·²ç¼–è¯‘ï¼š`cd ../../build && make`
2. æ£€æŸ¥åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š`find ../../build -name "*.a" -o -name "*.so"`
3. é‡æ–°è¿è¡Œ cmakeï¼š`cd build && rm -rf * && cmake .. && make`

### é—®é¢˜ 3ï¼šæ®µé”™è¯¯ï¼ˆSegmentation Faultï¼‰

**ç—‡çŠ¶ï¼š** ç¨‹åºå´©æºƒ

**è§£å†³æ–¹æ¡ˆï¼š**
1. ä½¿ç”¨ gdb è°ƒè¯•ï¼š`gdb ./test_server` æˆ– `gdb ./test_client`
2. æ£€æŸ¥å…±äº«å†…å­˜å¤§å°æ˜¯å¦è¶³å¤Ÿ
3. æ£€æŸ¥æŒ‡é’ˆæ˜¯å¦æœ‰æ•ˆ

### é—®é¢˜ 4ï¼šå…±äº«å†…å­˜æ³„æ¼

**ç—‡çŠ¶ï¼š** `/dev/shm/` ä¸‹æ®‹ç•™æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ¸…ç†æ‰€æœ‰ zerocp ç›¸å…³çš„å…±äº«å†…å­˜
rm -f /dev/shm/zerocp_*

# æˆ–è€…ä½¿ç”¨ ipcs å’Œ ipcrm å‘½ä»¤
ipcs -m
ipcrm -m <shmid>
```

## ğŸ“ ä»£ç ç»“æ„

### MemPoolManager æ ¸å¿ƒ API

```cpp
// åˆ›å»ºå…±äº«å®ä¾‹ï¼ˆæœåŠ¡ç«¯ï¼‰
bool MemPoolManager::createSharedInstance(const MemPoolConfig& config);

// è·å–å®ä¾‹ï¼ˆå®¢æˆ·ç«¯ï¼‰
MemPoolManager* MemPoolManager::getInstanceIfInitialized();

// åˆ†é… chunk
ChunkManager* getChunk(uint64_t size);

// é‡Šæ”¾ chunk
bool releaseChunk(ChunkManager* chunkManager);

// æ‰“å°çŠ¶æ€
void printAllPoolStats();

// é”€æ¯å®ä¾‹
void destroySharedInstance();
```

### MemPoolConfig é…ç½®

```cpp
MemPoolConfig config;
config.addMemPoolEntry(chunkSize, chunkCount);
```

### ChunkManager ç»“æ„

```cpp
struct ChunkManager {
    RelativePointer<ChunkHeader> m_chunkHeader;
    RelativePointer<MemPool> m_mempool;
    RelativePointer<MemPool> m_chunkManagementPool;
    std::atomic<uint64_t> m_refCount;
};
```

## ğŸ“ å­¦ä¹ è¦ç‚¹

1. **å…±äº«å†…å­˜æœºåˆ¶**ï¼šç†è§£ POSIX å…±äº«å†…å­˜çš„åˆ›å»ºå’Œæ˜ å°„
2. **å¤šè¿›ç¨‹é€šä¿¡**ï¼šæœåŠ¡ç«¯åˆ›å»ºï¼Œå®¢æˆ·ç«¯è¿æ¥
3. **å†…å­˜æ± ç®¡ç†**ï¼šä¸åŒå¤§å°çš„å†…å­˜æ± ï¼Œè‡ªåŠ¨é€‰æ‹©
4. **ç›¸å¯¹æŒ‡é’ˆ**ï¼šè·¨è¿›ç¨‹çš„æŒ‡é’ˆè¡¨ç¤º
5. **å¼•ç”¨è®¡æ•°**ï¼šå†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†
6. **æ— é”æ•°æ®ç»“æ„**ï¼šMPMC æ— é”é˜Ÿåˆ—

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MemPoolManager è®¾è®¡æ–‡æ¡£](../../docs/MemPoolManager_In_SharedMemory_Design.md)
- [åŒå…±äº«å†…å­˜æ¶æ„](../../docs/Dual_SharedMemory_Architecture.md)
- [ç›¸å¯¹æŒ‡é’ˆä½¿ç”¨æŒ‡å—](../../zerocp_foundationLib/posix/memory/RELATIVE_POINTER_USAGE.md)

## ğŸ¤ è´¡çŒ®

å¦‚æœå‘ç°é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ– Pull Requestã€‚

## ğŸ“„ è®¸å¯è¯

ä¸ä¸»é¡¹ç›®ç›¸åŒã€‚


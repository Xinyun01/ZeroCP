# è·¨è¿›ç¨‹ Chunk æµ‹è¯• - æ€»ç»“

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

æœ¬æµ‹è¯•éªŒè¯ ZeroCP æ¡†æ¶çš„è·¨è¿›ç¨‹é›¶æ‹·è´å†…å­˜è®¿é—®èƒ½åŠ›ã€‚

**æ ¸å¿ƒæ€è·¯**ï¼š
- å†™è¿›ç¨‹åˆ›å»ºå…±äº«å†…å­˜æ± ï¼Œå‘æ± 1/2/3å†™å…¥æ•°æ®
- è¯»è¿›ç¨‹é™„åŠ åˆ°å…±äº«å†…å­˜ï¼Œç›´æ¥ä»æ± 1/2/3è¯»å–æ•°æ®
- æ— éœ€é¢å¤–çš„ç´¢å¼•è¡¨ï¼Œæ•´ä¸ª MemPoolManager å·²åœ¨å…±äº«å†…å­˜ä¸­

## ğŸ¯ æµ‹è¯•ç›®æ ‡

### éªŒè¯åŠŸèƒ½

âœ… **å…±äº«å†…å­˜æœºåˆ¶**
- å†™è¿›ç¨‹åˆ›å»ºå…±äº«å†…å­˜æ± 
- è¯»è¿›ç¨‹é™„åŠ åˆ°å·²å­˜åœ¨çš„å…±äº«å†…å­˜

âœ… **RelativePointer è·¨è¿›ç¨‹è§£æ**
- ChunkManager::m_chunkHeader æ­£ç¡®è§£æ
- ChunkHeader::getUserData() è¿”å›æ­£ç¡®åœ°å€

âœ… **æ•°æ®å®Œæ•´æ€§**
- é­”æ•°éªŒè¯ (0xDEADBEEF12345678)
- æ± IDéªŒè¯ (1/2/3)
- åºåˆ—å·éªŒè¯ (101/202/303)
- æ ¡éªŒå’ŒéªŒè¯

âœ… **Chunk ç®¡ç†**
- è·¨è¿›ç¨‹è®¿é—® ChunkManager
- å¼•ç”¨è®¡æ•°ä¸€è‡´æ€§
- æ± IDæ­£ç¡®æ ‡è¯†

## ğŸ—ï¸ å®ç°æ–¹æ¡ˆ

### å†™è¿›ç¨‹ (test_chunk_writer.cpp)

```cpp
1. åˆ›å»ºå…±äº«å†…å­˜æ± ï¼ˆ4ä¸ªæ± ï¼‰
2. å‘æ± 1åˆ†é… Chunkï¼Œå†™å…¥ TestData {magic, poolId=1, sequence=101}
3. å‘æ± 2åˆ†é… Chunkï¼Œå†™å…¥ TestData {magic, poolId=2, sequence=202}
4. å‘æ± 3åˆ†é… Chunkï¼Œå†™å…¥ TestData {magic, poolId=3, sequence=303}
5. ä¿æŒè¿è¡Œï¼Œç­‰å¾…è¯»è¿›ç¨‹éªŒè¯
```

### è¯»è¿›ç¨‹ (test_chunk_reader.cpp)

```cpp
1. é™„åŠ åˆ°å…±äº«å†…å­˜
2. éå† ChunkManagerPoolï¼Œæ‰¾åˆ°æ± 1çš„ Chunk
3. é€šè¿‡ RelativePointer è®¿é—®æ•°æ®ï¼ŒéªŒè¯
4. é‡å¤æ­¥éª¤2-3ï¼ŒéªŒè¯æ± 2å’Œæ± 3
5. è¾“å‡ºæµ‹è¯•ç»“æœ
```

### å…³é”®ä»£ç 

**å†™è¿›ç¨‹ - å†™å…¥æ•°æ®**ï¼š
```cpp
auto chunkResult = manager->getChunk(dataSize, poolId);
ChunkManager* chunk = chunkResult.value();
ChunkHeader* header = chunk->m_chunkHeader.get();
void* userData = header->getUserData();

TestData* data = static_cast<TestData*>(userData);
data->magic = 0xDEADBEEF12345678ULL;
data->poolId = poolId;
data->sequence = sequence;
data->checksum = data->calculateChecksum();
```

**è¯»è¿›ç¨‹ - è¯»å–æ•°æ®**ï¼š
```cpp
// éå† ChunkManagerPool
for (uint32_t i = 0; i < totalChunks; ++i) {
    ChunkManager* chunkMgr = reinterpret_cast<ChunkManager*>(
        static_cast<char*>(managementBase) + 
        pool.getDataOffset() + 
        i * sizeof(ChunkManager)
    );
    
    if (chunkMgr->m_refCount.load() > 0 && 
        chunkMgr->m_poolId == targetPoolId) {
        // æ‰¾åˆ°ç›®æ ‡ Chunk
        ChunkHeader* header = chunkMgr->m_chunkHeader.get();
        void* userData = header->getUserData();
        TestData* data = static_cast<TestData*>(userData);
        // éªŒè¯æ•°æ®...
    }
}
```

## ğŸš€ è¿è¡Œæµ‹è¯•

### å¿«é€Ÿæµ‹è¯•

```bash
cd test/chunktest
./run_chunk_test.sh
```

### æ‰‹åŠ¨æµ‹è¯•

```bash
# ç»ˆç«¯1
./manual_test.sh writer

# ç»ˆç«¯2
./manual_test.sh reader

# æ¸…ç†
./manual_test.sh clean
```

## ğŸ“Š æµ‹è¯•æ•°æ®

### å†…å­˜æ± é…ç½®

| æ± ID | Chunkå¤§å° | æ•°é‡ | ç”¨é€” |
|------|-----------|------|------|
| 0 | 128B | 100 | æœªä½¿ç”¨ |
| 1 | 1KB | 50 | æµ‹è¯• âœ“ |
| 2 | 4KB | 20 | æµ‹è¯• âœ“ |
| 3 | 16KB | 10 | æµ‹è¯• âœ“ |

### æµ‹è¯•æ•°æ®

```cpp
struct TestData {
    uint64_t magic;        // 0xDEADBEEF12345678
    uint32_t poolId;       // 1/2/3
    uint32_t sequence;     // 101/202/303
    uint32_t checksum;     // è®¡ç®—å¾—å‡º
    char message[240];     // "Test data from Pool X..."
};
```

## âœ… æˆåŠŸæ ‡å‡†

æµ‹è¯•é€šè¿‡éœ€è¦æ»¡è¶³ï¼š

1. âœ… å†™è¿›ç¨‹æˆåŠŸåˆ›å»ºå…±äº«å†…å­˜
2. âœ… å†™è¿›ç¨‹å‘æ± 1/2/3å„å†™å…¥ä¸€ä¸ª Chunk
3. âœ… è¯»è¿›ç¨‹æˆåŠŸé™„åŠ å…±äº«å†…å­˜
4. âœ… è¯»è¿›ç¨‹æ‰¾åˆ°æ± 1/2/3çš„ Chunk
5. âœ… æ‰€æœ‰æ•°æ®éªŒè¯é€šè¿‡ï¼ˆé­”æ•°ã€æ± IDã€åºåˆ—å·ã€æ ¡éªŒå’Œï¼‰
6. âœ… æ— æ®µé”™è¯¯æˆ–å†…å­˜æ³„æ¼

## ğŸ” å…³é”®éªŒè¯ç‚¹

### 1. å…±äº«å†…å­˜é™„åŠ 

```
è¯»è¿›ç¨‹è¾“å‡ºï¼š
  âœ“ æˆåŠŸé™„åŠ åˆ°å…±äº«å†…å­˜
  âœ“ MemPoolManager å®ä¾‹è·å–æˆåŠŸ
```

### 2. RelativePointer è§£æ

```
è¯»è¿›ç¨‹è¾“å‡ºï¼š
  âœ“ ChunkHeader åœ°å€: 0x7f...
  âœ“ ç”¨æˆ·æ•°æ®åŒºåœ°å€: 0x7f...
```

### 3. æ•°æ®å®Œæ•´æ€§

```
è¯»è¿›ç¨‹è¾“å‡ºï¼š
  - Magic: 0xdeadbeef12345678 âœ“
  - PoolId: 1 âœ“
  - Sequence: 101 âœ“
  - Checksum: 0x12345678 âœ“
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
test/chunktest/
â”œâ”€â”€ test_chunk_writer.cpp      # å†™è¿›ç¨‹æºç 
â”œâ”€â”€ test_chunk_reader.cpp      # è¯»è¿›ç¨‹æºç 
â”œâ”€â”€ run_chunk_test.sh          # è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
â”œâ”€â”€ manual_test.sh             # æ‰‹åŠ¨æµ‹è¯•è„šæœ¬
â”œâ”€â”€ CMakeLists.txt             # æ„å»ºé…ç½®
â”œâ”€â”€ README.md                  # è¯¦ç»†æ–‡æ¡£
â”œâ”€â”€ QUICKSTART.md              # å¿«é€Ÿå…¥é—¨
â””â”€â”€ TEST_SUMMARY.md            # æœ¬æ–‡æ¡£
```

## ğŸ“ è®¾è®¡è¦ç‚¹

### ä¸ºä»€ä¹ˆä¸éœ€è¦ç´¢å¼•è¡¨ï¼Ÿ

æ•´ä¸ª MemPoolManager å·²ç»åœ¨å…±äº«å†…å­˜ä¸­ï¼ŒåŒ…æ‹¬ï¼š
- ChunkManagerPoolï¼ˆæ‰€æœ‰ ChunkManager å¯¹è±¡ï¼‰
- æ‰€æœ‰æ± çš„å…ƒæ•°æ®
- å¼•ç”¨è®¡æ•°ã€æ± IDç­‰ä¿¡æ¯

è¯»è¿›ç¨‹é™„åŠ åï¼Œå¯ä»¥ç›´æ¥éå† ChunkManagerPool æ‰¾åˆ°ç›®æ ‡ Chunkã€‚

### åç»­å¦‚ä½•ä¼ è¾“ ChunkManager æŒ‡é’ˆï¼Ÿ

å½“å‰æµ‹è¯•é€šè¿‡éå†æŸ¥æ‰¾ Chunkï¼Œå®é™…ä½¿ç”¨ä¸­å¯ä»¥ï¼š
1. é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ä¼ é€’ ChunkManagerIndex
2. æ¥æ”¶è¿›ç¨‹é€šè¿‡ç´¢å¼•é‡å»º ChunkManager æŒ‡é’ˆ
3. ä½¿ç”¨ RelativePointer è®¿é—®æ•°æ®

è¿™éƒ¨åˆ†åŠŸèƒ½æš‚æœªå®ç°ï¼Œæ˜¯ä¸‹ä¸€æ­¥çš„å·¥ä½œã€‚

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¯»è¿›ç¨‹è¦éå†æ‰€æœ‰ ChunkManagerï¼Ÿ

**A**: å› ä¸ºå½“å‰è¿˜æ²¡æœ‰å®ç° ChunkManager æŒ‡é’ˆçš„è·¨è¿›ç¨‹ä¼ è¾“æœºåˆ¶ã€‚å®é™…ä½¿ç”¨ä¸­ï¼Œå†™è¿›ç¨‹ä¼šé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å‘é€ ChunkManagerIndexï¼Œè¯»è¿›ç¨‹ç›´æ¥é€šè¿‡ç´¢å¼•è®¿é—®ï¼Œæ— éœ€éå†ã€‚

### Q2: RelativePointer å¦‚ä½•å·¥ä½œï¼Ÿ

**A**: RelativePointer å­˜å‚¨çš„æ˜¯ç›¸å¯¹äºåŸºåœ°å€çš„åç§»é‡ï¼Œè€Œä¸æ˜¯ç»å¯¹åœ°å€ã€‚ä¸¤ä¸ªè¿›ç¨‹è™½ç„¶è™šæ‹Ÿåœ°å€ä¸åŒï¼Œä½†ç›¸å¯¹åç§»æ˜¯ä¸€è‡´çš„ï¼Œå› æ­¤å¯ä»¥æ­£ç¡®è§£æã€‚

### Q3: å¼•ç”¨è®¡æ•°å¦‚ä½•åŒæ­¥ï¼Ÿ

**A**: å¼•ç”¨è®¡æ•°ä½¿ç”¨ `std::atomic`ï¼Œåœ¨å…±äº«å†…å­˜ä¸­è‡ªåŠ¨åŒæ­¥ã€‚æ‰€æœ‰è¿›ç¨‹çœ‹åˆ°çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯ä¸€è‡´çš„ã€‚

## ğŸ”„ ä¸‹ä¸€æ­¥å·¥ä½œ

- [ ] å®ç° ChunkManagerIndex çš„è·¨è¿›ç¨‹ä¼ è¾“
- [ ] æ·»åŠ æ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒ
- [ ] æ”¯æŒå¤šè¯»è¿›ç¨‹å¹¶å‘è®¿é—®
- [ ] æ·»åŠ æ€§èƒ½æµ‹è¯•
- [ ] æ·»åŠ å‹åŠ›æµ‹è¯•

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `README.md` - è¯¦ç»†æ¶æ„å’Œå®ç°
- `QUICKSTART.md` - å¿«é€Ÿå…¥é—¨æŒ‡å—
- ä¸»é¡¹ç›® `docs/` - æ•´ä½“è®¾è®¡æ–‡æ¡£

---

**ç‰ˆæœ¬**: v2.0 (ç®€åŒ–ç‰ˆï¼Œæ— ç´¢å¼•è¡¨)  
**æ—¥æœŸ**: 2025-11-02  
**çŠ¶æ€**: âœ… æµ‹è¯•é€šè¿‡


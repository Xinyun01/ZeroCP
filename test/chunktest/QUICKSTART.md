# 🚀 快速开始 - 跨进程 Chunk 测试

## 一分钟快速测试

```bash
# 进入测试目录
cd test/chunktest

# 运行自动化测试
./run_chunk_test.sh
```

就这么简单！脚本会自动完成所有步骤。

## 📋 测试内容

本测试验证：

1. **写进程**创建共享内存池，向池1/2/3写入数据
2. **读进程**附加到共享内存，从池1/2/3读取并验证数据
3. **RelativePointer** 在不同进程地址空间中正确工作
4. **数据完整性**通过魔数、校验和等验证

## 🎯 预期结果

### 成功输出

```
========================================
  测试结果总结
========================================
✓✓✓ 所有测试通过！✓✓✓

成功验证：
  1. 跨进程共享内存附加成功
  2. 从池1/2/3读取数据成功
  3. RelativePointer 地址转换正确
  4. 数据完整性验证通过
  5. 跨进程零拷贝访问成功
========================================
```

### 关键验证点

- ✅ 写进程向池1写入 1KB 数据 (sequence=101)
- ✅ 写进程向池2写入 4KB 数据 (sequence=202)
- ✅ 写进程向池3写入 16KB 数据 (sequence=303)
- ✅ 读进程成功附加共享内存
- ✅ 读进程从池1/2/3读取并验证所有数据
- ✅ 魔数 0xDEADBEEF12345678 验证通过
- ✅ 校验和验证通过

## 🔧 手动测试（可选）

如果你想分步观察测试过程：

### 终端1：启动写进程

```bash
./manual_test.sh writer
```

输出示例：
```
========================================
  跨进程 Chunk 测试 - 写进程
========================================

[1] 创建共享内存池...
  ✓ 共享内存池创建成功

[3] 向内存池 1/2/3 写入测试数据...
  ✓✓✓ 池 1 数据写入成功！✓✓✓
  ✓✓✓ 池 2 数据写入成功！✓✓✓
  ✓✓✓ 池 3 数据写入成功！✓✓✓

写进程将保持运行，等待读进程验证数据...
```

### 终端2：启动读进程

```bash
./manual_test.sh reader
```

按 Enter 开始验证，输出示例：
```
[1] 附加到已存在的共享内存...
  ✓ 成功附加到共享内存

[3] 从内存池 1/2/3 读取并验证数据...
  ✓✓✓ 池 1 数据验证成功！✓✓✓
  ✓✓✓ 池 2 数据验证成功！✓✓✓
  ✓✓✓ 池 3 数据验证成功！✓✓✓

✓✓✓ 所有测试通过！✓✓✓
```

### 清理

```bash
# 在终端1按 Ctrl+C 停止写进程

# 清理共享内存
./manual_test.sh clean
```

## 🐛 常见问题

### 问题1：附加失败

```
附加到共享内存失败
```

**解决**：确保写进程正在运行
```bash
ps aux | grep test_chunk_writer
```

### 问题2：找不到可执行文件

```
错误: 请先编译测试程序
```

**解决**：先构建主项目
```bash
cd ../../  # 回到项目根目录
mkdir -p build && cd build
cmake ..
make -j4
```

### 问题3：残留共享内存

```bash
# 清理
./manual_test.sh clean

# 或手动清理
rm -f /dev/shm/zerocp_*
```

## 📊 测试数据结构

每个池写入的数据：

```cpp
struct TestData {
    uint64_t magic;        // 0xDEADBEEF12345678
    uint32_t poolId;       // 1/2/3
    uint32_t sequence;     // 101/202/303
    uint32_t checksum;     // 自动计算
    char message[240];     // "Test data from Pool X..."
};
```

- **池1** (1KB): sequence=101, poolId=1
- **池2** (4KB): sequence=202, poolId=2
- **池3** (16KB): sequence=303, poolId=3

## 🎓 测试流程

```
1. 写进程创建共享内存
   └─ 4个池: 128B, 1KB, 4KB, 16KB

2. 写进程向池1/2/3写入数据
   └─ 每个池写入一个 TestData 结构

3. 读进程附加到共享内存
   └─ 使用 attachToSharedInstance()

4. 读进程遍历 ChunkManagerPool
   └─ 找到属于池1/2/3的 Chunk

5. 读进程验证数据
   └─ 检查 magic, poolId, sequence, checksum

6. 测试完成
   └─ 清理共享内存
```

## 📁 相关文件

- `test_chunk_writer.cpp` - 写进程源码
- `test_chunk_reader.cpp` - 读进程源码
- `run_chunk_test.sh` - 自动化测试脚本
- `manual_test.sh` - 手动测试脚本
- `README.md` - 详细文档

## 🔍 查看日志

自动化测试的日志保存在：

```bash
# 查看写进程日志
cat logs/writer.log

# 查看读进程日志
cat logs/reader.log
```

## ✅ 成功标志

测试成功的标志：

1. 写进程成功创建共享内存
2. 写进程向3个池写入数据
3. 读进程成功附加共享内存
4. 读进程从3个池读取数据
5. 所有数据验证通过
6. 退出码为 0

## 🎯 下一步

测试通过后，你可以：

1. 查看 `README.md` 了解详细架构
2. 修改测试数据结构进行实验
3. 添加更多池或更多数据
4. 实现自己的跨进程通信逻辑

---

**需要帮助？** 查看 `README.md` 中的故障排查部分。
